<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCE Workbench</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #FFDE59;
        }
        .container {
            margin: 0 auto;
          	height: 100%;
          	overflow-y: auto;
          	border-radius: 0px;
            border: 3px solid #000;
            box-shadow: 7px 7px 0px #000;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }
        .sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
          	padding: 20px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .section {
            min-height: auto;
            border-radius: 0px;
            border: 3px solid #000;
            margin-bottom: 10px;
            padding: 20px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #ffffff;
            box-shadow: 5px 5px 0px #000;
        }
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 8px 8px 0px #000;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #000;
            border-bottom: 3px solid #000;
            padding-bottom: 5px;
        }
        .section-content {
            color: #000;
            line-height: 1.6;
          	font-size: 1.1em;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .active {
            background-color: #A8E4FF;
            border-left: 10px solid #000;
        }
        #section16.active {
            background-color: #FF6B6B;
            border-left: 10px solid #000;
        }
        .tree-view {
            font-family: Arial, sans-serif;
            max-width: auto;
            margin: 0 auto;
        }
        .tick-mark {
            color: green;
            margin-left: 5px;
        }
        .tree-item {
            margin-bottom: 5px;
        }
        .tree-item-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 0px;
            border: 2px solid #000;
        }
        .tree-item-header:hover {
            background-color: #A8E4FF;
            transform: translateY(-2px);
            box-shadow: 3px 3px 0px #000;
        }
        .tree-item-content {
            margin-left: 20px;
            display: none;
        }
        .tree-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            transition: transform 0.3s;
        }
        .tree-item.open > .tree-item-header .tree-item-icon {
            transform: rotate(90deg);
        }
        .tree-item.open > .tree-item-content {
            display: block;
        }
        .case-item {
            padding: 5px;
            margin: 5px 0;
            background-color: #e8f0fe;
            border-radius: 0px;
            border: 2px solid #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .case-item:hover {
            background-color: #A8E4FF;
            transform: translateY(-2px);
            box-shadow: 3px 3px 0px #000;
        }
        .loading {
            color: #888;
            font-style: italic;
            margin-left: 25px;
        }

        .lock-icon {
            width: 16px;
            height: 16px;
            margin-left: 5px;
            fill: #000;
        }
        .tree-item-header.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Add styles for selected tree items */
        .tree-item-header.selected {
            background-color: #FFDE59;
            border-left: 4px solid #000;
            font-weight: bold;
        }
        
        .case-item.selected {
            background-color: #FFDE59;
            border-left: 4px solid #000;
            font-weight: bold;
        }
        
        .loading-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }    
        #timerWidget {
            background-color: white;
            border: 3px solid #000;
            padding: 5px 15px;
            border-radius: 0px;
            width: auto;
            font-size: 12px;
            text-align: center;
            box-shadow: 4px 4px 0px #000;
            display: flex;
            align-items: center;
        }
        
        #timerWidget #expandedLabel {
            display: none; /* Always hide the expanded label */
        }
        
        #timerWidget #expandedContent {
            display: flex; /* Always show the content */
            align-items: center;
        }
        
        /* Adjust mode buttons in topbar */
        #topbar .mode-button {
            padding: 8px 15px;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #000;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
        }
        
        #topbar .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }
        
        #topbar .mode-button.active {
            background-color: #FFDE59;
            color: #000;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #FFDE59;
        }

        #jitsi-container {
            width: 100%;
            height: 300px; /* Fixed height for the step container */
            position: relative;
            overflow: hidden;
            border-radius: 0px;
            border: 3px solid #000;
            margin: 20px auto;
            box-shadow: 7px 7px 0px #000;
            background-color: white;
            z-index: 1;
            box-sizing: border-box;
        }

        .mode-practice #jitsi-container {
            height: 300px;
            margin: 20px;
        }

        /* Media query for smaller screens */
        @media screen and (max-width: 768px) {
            .sections {
                height: 70vh;
            }
        }

        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #000;
            border-top: 5px solid #FFDE59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } 

        /* Checkbox styles */
        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            border: 2px solid #000;
        }

        /* Performance review styles */
        .performance-section {
            margin: 20px 0;
            padding: 15px;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
        }

        .performance-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #000;
            font-size: 1.2em;
            text-transform: uppercase;
        }

        /* Main layout - adjusting for fixed topbar */
        .main-container {
            display: block;
            padding: 20px 0;
            height: calc(100vh - 60px);
            margin-top: 60px;
            background-color: #FFDE59;
            overflow-x: hidden;
            overflow-y: hidden;
        }

        .main-content {
            background: white;
            border-radius: 0px;
            padding: 0;
            box-shadow: 7px 7px 0px #000;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            border: 3px solid #000;
        }

        /* Info box styles */
        .info-box {
            background-color: #f8f9fa;
            border: 3px solid #000;
            border-radius: 0px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 5px 5px 0px #000;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-box-title {
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-transform: uppercase;
            text-align: center;
        }

        .info-box h4 {
            color: #000;
            font-size: 1em;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #000;
        }

        .info-box ul {
            list-style-type: disc;
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Button styles */
        .action-button {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 10px 20px;
            border-radius: 0px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
            box-shadow: 5px 5px 0px #000;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 0px #000;
        }
        
        .action-button:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }

        /* Mode switch styles */
        .mode-switch {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-button {
            padding: 10px 20px;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 5px 5px 0px #000;
        }

        .mode-button.active {
            background-color: #FFDE59;
            color: #000;
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }

        /* Timestamp selector styles */
        .timestamp-selector {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 3px solid #000;
            border-radius: 0px;
            background-color: white;
            box-shadow: 4px 4px 0px #000;
            font-size: 0.9em;
            max-width: 100%;
            text-overflow: ellipsis;
        }

        /* Add new styles for error container */
        #errorContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #ff6666;
            color: white;
            border-radius: 0px;
            border: 3px solid #000;
            box-shadow: 5px 5px 0px #000;
            font-weight: bold;
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        #successContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #66cc66;
            color: white;
            border-radius: 0px;
            border: 3px solid #000;
            box-shadow: 5px 5px 0px #000;
            font-weight: bold;
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .mode-specific {
            transition: opacity 0.3s ease;
        }

        .review-only {
            display: none;
        }

        .practice-only {
            display: none;
        }

        .mode-review .review-only {
            display: block;
        }

        .mode-practice .practice-only {
            display: block;
        }

        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #000;
            border-top: 5px solid #FFDE59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Topbar styles */
        #topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #fff;
            box-shadow: 0 4px 0px #000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            border-bottom: 3px solid #000;
        }

        #topbar-left {
            display: flex;
            align-items: center;
        }

        #topbar-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        #topbar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Media query for smaller screens to fix button overlap */
        @media (max-width: 1024px) {
            #topbar {
                padding: 0 10px;
            }
            
            #topbar-center {
                position: static;
                transform: none;
                margin: 0 auto;
            }
            
            #topbar {
                justify-content: space-between;
            }
            
            #brainbank-button, #performance-button {
                font-size: 12px !important;
                padding: 6px 10px !important;
                gap: 3px !important;
            }
            
            #performance-button {
                margin-left: 5px !important;
            }
            
            #topbar-right .mode-button {
                font-size: 14px !important;
                padding: 6px 10px !important;
            }
            
            /* Reduce padding in timer buttons for tablet view */
            .timer-button {
                width: 26px !important;
                height: 26px !important;
            }
            
            /* Make the timer text slightly smaller */
            #time {
                font-size: 1em !important;
            }
        }

        /* Even smaller screens like phones */
        @media (max-width: 768px) {
            .mobile-menu-button {
                display: block;
            }
            
            #topbar-left {
                width: auto;
            }
            
            #topbar-center {
                position: static;
                transform: none;
                flex: 1;
                display: flex;
                justify-content: center;
            }
            
            #topbar-right {
                display: none;
            }
            
            #brainbank-button, #performance-button {
                display: none;
            }
            
            #topbar {
                justify-content: flex-start;
            }
        }

        #brainbank-button {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 8px 15px;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s ease;
        }

        #brainbank-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }
        
        #brainbank-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Lightbox styles */
        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #lightbox-content {
            background-color: white;
            width: 80%;
            max-width: 900px;
            height: 80%;
            border-radius: 0px;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 3px solid #000;
            box-shadow: 10px 10px 0px #000;
        }

        #lightbox-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 3px solid #000;
            font-size: 24px;
            cursor: pointer;
            color: #000;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0px;
            background-color: #FFDE59;
            box-shadow: 3px 3px 0px #000;
        }
        
        #lightbox-close:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 0px #000;
        }
        
        #lightbox-close:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px #000;
        }
        
        #lightbox h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
        }
        
        #lightbox-treeView {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
            width: 90%;
        }

        /* Add loading state styles */
        #lightbox-loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 2001;
        }

        #lightbox-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #000;
            border-top: 4px solid #FFDE59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Timer button styling */
        .timer-button {
            background-color: white;
            border: 2px solid #000;
            border-radius: 0px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 2px;
            box-shadow: 2px 2px 0px #000;
            transition: all 0.2s;
        }
        
        .timer-button:hover {
            transform: translateY(-2px);
            box-shadow: 3px 3px 0px #000;
        }
        
        .timer-button:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #000;
        }
        
        .timer-button svg {
            stroke: #000;
        }
        
        #time {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        /* Button container styling */
        #buttonContainer {
            display: flex;
            margin-left: 8px;
        }

        /* Tab layout styles */
        .tab-container {
            display: flex;
            height: 100%;
            gap: 20px;
            padding: 0 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .mode-practice .tab-container {
            display: none;
        }

        .tab-list {
            width: 250px;
            min-width: 250px;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
            overflow-y: auto;
            height: calc(100% - 30px);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .tab-button {
            display: block;
            width: 100%;
            padding: 15px;
            text-align: left;
            background: none;
            border: none;
            border-bottom: 2px solid #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
            position: relative;
            overflow: hidden;
        }

        .tab-button:last-child {
            border-bottom: none;
        }

        .tab-button:hover {
            background-color: #FFDE59;
        }

        .tab-button.active {
            background-color: #FFDE59;
            border-right: 5px solid #000;
            color: #000;
        }

        .tab-button:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #000;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab-button:hover:after {
            transform: scaleX(1);
        }

        .tab-content {
            flex: 0 0 800px;
            width: 800px;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
            padding: 20px;
            overflow-y: auto;
            margin: 20px auto 30px;
            height: calc(100% - 70px);
        }

        .tab-panel {
            display: none;
            width: 100%; /* Take full width of parent */
            max-width: 100%;
        }

        .tab-panel.active {
            display: block;
        }

        /* Make sure images don't overflow */
        img {
            max-width: 100%;
            height: auto;
        }

        /* Add media query for smaller screens */
        @media screen and (max-width: 1200px) {
            .tab-content {
                flex: 0 0 600px;
                width: 600px;
            }
        }

        @media screen and (max-width: 992px) {
            .tab-content {
                flex: 0 0 500px;
                width: 500px;
            }
        }

        /* Add new styles for candidate info grid */
        .candidate-info-grid {
            display: grid;
            gap: 20px;
            padding: 10px 0;
        }

        .candidate-info-item {
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }

        .candidate-info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .candidate-info-item strong {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-size: 1.1em;
        }

        .practice-welcome-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
            margin: 20px;
        }

        .practice-welcome-screen.active {
            display: flex;
        }

        .practice-welcome-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 30px;
            color: #000;
        }

        .practice-welcome-description {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 40px;
            max-width: 800px;
            color: #333;
        }

        .practice-buttons {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .practice-button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 5px 5px 0px #000;
            transition: all 0.2s;
            min-width: 250px;
        }

        .practice-button:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 0px #000;
        }

        .practice-button:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }

        .practice-button.primary {
            background-color: #FFDE59;
        }

        @media (max-width: 768px) {
            .practice-buttons {
                flex-direction: column;
                width: 100%;
            }

            .practice-button {
                width: 100%;
            }
        }

        .simulator-link-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: calc(100% - 80px);
            padding: 40px;
            text-align: center;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
            margin: 80px 20px 20px 20px;
            overflow-y: auto;
            position: relative;
        }

        .simulator-link-screen.active {
            display: flex;
            width: 80%;
            margin: 80px auto 20px auto;
        }

        .simulator-link-title {
            margin-top: 0;
            top: 0;
            background-color: white;
            padding: 10px 0;
            width: 100%;
            z-index: 5;
        }

        .simulator-steps {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            position: relative;
            z-index: 2;
        }

        .simulator-step {
            text-align: left;
            padding: 20px;
            margin-bottom: 30px;
            background-color: #f8f9fa;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
            position: relative;
        }

        .simulator-step-number {
            position: absolute;
            top: -15px;
            left: -15px;
            width: 40px;
            height: 40px;
            background-color: #FFDE59;
            border: 3px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 3px 3px 0px #000;
        }

        .simulator-step-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 30px;
        }

        .simulator-step-content {
            padding: 10px 0;
        }

        .simulator-link-box {
            width: 100%;
            padding: 15px;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            font-family: monospace;
            font-size: 1.1em;
            word-break: break-word;
            overflow-wrap: break-word;
            text-align: left;
            margin-bottom: 10px;
            box-sizing: border-box;
            height: auto;
        }

        .simulator-step-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            margin-top: 15px;
        }

        .simulator-button {
            padding: 12px 25px;
            font-size: 1.1em;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .simulator-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .simulator-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        .simulator-button.primary {
            background-color: #FFDE59;
        }

        .simulator-button.back {
            background-color: #f0f0f0;
        }

        /* Floating back button for practice mode */
        .floating-back-button {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            background-color: #f0f0f0;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
            padding: 10px 15px;
            display: none;
        }

        .floating-back-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .floating-back-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Only show the back button in practice mode and not when welcome screen is active */
        .mode-practice .floating-back-button {
            display: none; /* Hide by default in practice mode */
        }

        /* Make absolutely sure the back button is hidden when welcome screen is active */
        .practice-welcome-screen.active ~ .floating-back-button,
        body.mode-practice .practice-welcome-screen.active ~ .floating-back-button,
        .practice-welcome-screen.active + .floating-back-button,
        body.mode-practice .practice-welcome-screen.active + .floating-back-button {
            display: none !important; /* Higher specificity with !important */
        }

        /* Show back button in practice mode when it's explicitly displayed via JavaScript */
        .mode-practice .floating-back-button[style*="display: block"] {
            display: block !important;
        }

        @media (max-width: 768px) {
            .floating-back-button {
                top: 70px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }

        .success-message {
            display: none;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            border-radius: 0px;
            background-color: #e8f5e9;
            border: 2px solid #28a745;
        }

        @media (max-width: 768px) {
            .simulator-link-screen {
                padding: 20px;
                margin-top: 80px;
            }
            
            .simulator-steps {
                max-width: 100%;
                margin: 10px auto;
            }

            .simulator-step {
                padding: 15px;
                margin-bottom: 20px;
            }

            .simulator-step-number {
                width: 30px;
                height: 30px;
            }

            .simulator-step-title {
                font-size: 1em;
                padding-left: 20px;
            }

            .simulator-step-content {
                padding: 5px 0;
            }

            .simulator-link-box {
                width: 100%;
                padding: 10px;
            }

            .simulator-step-buttons {
                flex-direction: column;
                width: 100%;
            }

            .simulator-button {
                width: 100%;
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-screen.active {
            display: flex;
        }

        .candidate-info-item strong {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-size: 1.1em;
        }

        /* Top candidate info styles */
        .top-candidate-info {
            background-color: #f8f9fa;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 5px 5px 0px #000;
            padding: 15px;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            margin: 20px 0;
            text-align: left;
            font-size: 1.2em;
        }
        
        .top-candidate-info .info-box-title {
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
            font-size: 1.3em;
            text-transform: uppercase;
            text-align: center;
        }
        
        .top-candidate-info .candidate-info-grid {
            display: grid;
            gap: 15px;
            padding: 5px 0;
        }
        
        .top-candidate-info .candidate-info-item {
            border-bottom: 1px solid #000;
            padding-bottom: 15px;
        }
        
        .top-candidate-info .candidate-info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .top-candidate-info .candidate-info-item strong {
            display: block;
            margin-bottom: 10px;
            color: #000;
            font-size: 1.2em;
        }
        
        /* Mobile responsiveness for top candidate info */
        @media (max-width: 768px) {
            .top-candidate-info .candidate-info-grid {
                grid-template-columns: 1fr;
            }
            
            .top-candidate-info {
                font-size: 1.1em;
            }
        }

        /* Enter Room Button Styles - matches the simulator-button primary style */
        #enterRoomBtn {
            display: block;
            margin: 20px auto;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            background-color: #FFDE59;
            color: black;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0px #000;
            max-width: 250px;
            width: 100%;
            text-align: center;
        }

        #enterRoomBtn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        #enterRoomBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Rest of the existing styles */

        /* Add the clipboard floating buttons and lightbox styles */
        .floating-clipboard-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: row; /* Changed from column to row */
            gap: 15px;
            z-index: 1000;
        }

        .clipboard-button {
            width: 150px;
            height: 140px;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 15px;
            box-shadow: 5px 5px 0px #000;
        }

        .clipboard-button:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 0px #000;
        }

        .clipboard-button:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }

        .clipboard-button.candidate {
            background-color: #A8E4FF;
        }

        .clipboard-button.findings {
            background-color: #FFDE59;
        }

        .clipboard-button span {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            color: #000;
            line-height: 1.2;
        }

        .clipboard-button svg {
            width: 50px;
            height: 50px;
            stroke: #000;
            stroke-width: 2;
            fill: none;
        }

        .content-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2001;
        }

        .content-lightbox-inner {
            background-color: white;
            width: 85%;
            max-width: 800px;
            max-height: 85%;
            border-radius: 0px;
            padding: 25px;
            position: relative;
            overflow-y: auto;
            border: 3px solid #000;
            box-shadow: 10px 10px 0px #000;
            font-size: 1.2em;
        }

        .content-lightbox-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: 3px solid #000;
            font-size: 28px;
            cursor: pointer;
            color: #000;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0px;
            background-color: #FFDE59;
            box-shadow: 3px 3px 0px #000;
        }

        .content-lightbox-close:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 0px #000;
        }

        .content-lightbox-close:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px #000;
        }
        
        /* Add styles for the content inside the lightboxes */
        .content-lightbox-inner .info-box-title {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #000;
            text-transform: uppercase;
        }
        
        .content-lightbox-inner .candidate-info-grid {
            display: grid;
            gap: 20px;
            padding: 10px 0;
        }
        
        .content-lightbox-inner .candidate-info-item {
            border-bottom: 1px solid #000;
            padding-bottom: 20px;
        }
        
        .content-lightbox-inner .candidate-info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .content-lightbox-inner .candidate-info-item strong {
            display: block;
            margin-bottom: 12px;
            color: #000;
            font-size: 1.2em;
        }
        
        /* Responsive styles for the lightboxes */
        @media (max-width: 768px) {
            .content-lightbox-inner {
                width: 90%;
                padding: 20px;
                font-size: 1.1em;
            }
            
            .content-lightbox-inner .info-box-title {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
            
            .content-lightbox-inner .candidate-info-item strong {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
        }

        /* Add styles for mobile menu and sidebar */
        .mobile-menu-button {
            display: none;
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            border-radius: 0px;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
        }

        .mobile-menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .mobile-menu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background-color: white;
            z-index: 2000;
            transition: left 0.3s ease;
            border-right: 3px solid #000;
            box-shadow: 5px 0px 15px rgba(0,0,0,0.2);
            overflow-y: auto;
            padding-top: 60px;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .sidebar-menu-button {
            background-color: white;
            color: #000;
            border: 3px solid #000;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            text-align: left;
            box-shadow: 4px 4px 0px #000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .sidebar-menu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        .sidebar-menu-button.active {
            background-color: #FFDE59;
        }

        /* Media query for mobile layout */
        @media (max-width: 768px) {
            .mobile-menu-button {
                display: block;
            }
            
            #topbar-left {
                width: auto;
            }
            
            #topbar-center {
                position: static;
                transform: none;
                flex: 1;
                display: flex;
                justify-content: center;
            }
            
            #topbar-right {
                display: none;
            }
            
            #brainbank-button {
                display: none;
            }
            
            #topbar {
                justify-content: flex-start;
            }
        }

        /* Add style for sidebar close button */
        .sidebar-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #FFDE59;
            border: 3px solid #000;
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 0px;
            box-shadow: 3px 3px 0px #000;
            transition: all 0.2s;
        }

        .sidebar-close:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 0px #000;
        }

        .sidebar-close:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Add these new styles for mobile tab optimization */
        @media (max-width: 768px) {
            .tab-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .tab-list {
                width: 100%;
                min-width: 100%;
                height: auto;
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                margin: 10px 0;
                padding: 10px 5px;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS devices */
                scrollbar-width: none; /* Hide scrollbar in Firefox */
            }
            
            .tab-list::-webkit-scrollbar {
                display: none; /* Hide scrollbar in Chrome/Safari/Edge */
            }
            
            .tab-button {
                width: 80px;
                min-width: 80px;
                height: 80px;
                flex: 0 0 auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 8px 5px;
                margin: 0 5px;
                border: 2px solid #000;
                border-radius: 0px;
                box-shadow: 3px 3px 0px #000;
            }
            
            .tab-button:last-child {
                border-right: 2px solid #000;
            }
            
            .tab-button .tab-icon {
                font-size: 24px;
                margin-bottom: 5px;
                margin-right: 0;
            }
            
            .tab-button .tab-label {
                font-size: 10px;
                line-height: 1.1;
                white-space: normal;
                word-wrap: break-word;
                max-width: 100%;
                text-align: center;
            }
            
            .tab-button.active {
                background-color: #FFDE59;
                transform: translate(2px, 2px);
                box-shadow: 1px 1px 0px #000;
            }
            
            .tab-content {
                width: 100%;
                margin: 0;
                border-radius: 0;
                flex: 1;
                height: calc(100% - 120px);
                min-height: 60vh;
                box-sizing: border-box;
            }
        }

        /* Add new styles for tablet screens (1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .tab-list {
                width: 150px;
                min-width: 150px;
            }
            
            .tab-button {
                padding: 12px 10px;
                font-size: 0.9em;
            }
            
            .tab-button .tab-icon {
                font-size: 16px;
            }
        }

        /* Adjust the existing tab styles to work better with the new mobile layout */
        .tab-button {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .tab-icon {
            margin-right: 10px;
        }

        .tab-label {
            flex: 1;
        }

        /* No changes needed for desktop view */
        @media (min-width: 769px) {
            .tab-button {
                text-align: left;
            }
            
            .tab-button .tab-icon {
                display: inline;
                margin-right: 10px;
            }
            
            .tab-button .tab-label {
                display: inline;
                font-size: 1em;
            }
        }

        /* Add more comprehensive mobile optimizations */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px 0;
                height: calc(100vh - 60px);
            }
            
            .main-content {
                padding: 0;
                height: 100%;
                box-sizing: border-box;
            }
            
            .tab-container {
                flex-direction: column;
                gap: 5px;
                padding: 5px;
                height: 100%;
                box-sizing: border-box;
            }
            
            .tab-list {
                width: 100%;
                min-width: 100%;
                height: auto;
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                margin: 10px 0;
                padding: 10px 5px;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                box-sizing: border-box;
                justify-content: flex-start;
                background-color: #f8f9fa;
            }
            
            .tab-button {
                width: 60px;
                min-width: 60px;
                height: 60px;
                flex: 0 0 auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding: 8px 5px;
                margin: 0 5px;
                border: 2px solid #000;
                border-radius: 0px;
                box-shadow: 3px 3px 0px #000;
                background-color: white;
            }
            
            .tab-button .tab-icon {
                font-size: 16px;
                margin-bottom: 8px;
                margin-right: 0;
            }
            
            .tab-button .tab-label {
                font-size: 8px;
                line-height: 1.1;
                white-space: normal;
                word-wrap: break-word;
                max-width: 100%;
                text-align: center;
            }
            
            .tab-button.active {
                background-color: #FFDE59;
                transform: translate(2px, 2px);
                box-shadow: 1px 1px 0px #000;
            }
            
            .tab-content {
                width: 100%;
                margin: 0;
                border-radius: 0;
                flex: 1;
                height: calc(100% - 130px);
                min-height: 60vh;
                padding: 15px;
                box-sizing: border-box;
                overflow-y: auto;
            }
            
            /* Fix info boxes layout on mobile */
            .info-box {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .candidate-info-grid {
                display: grid;
                gap: 10px;
            }
            
            /* Make scrolling smoother on mobile */
            .tab-content,
            .info-box {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Improve text readability on mobile */
            .info-box-title {
                font-size: 1em;
                padding: 5px 0;
            }
            
            .section-content {
                font-size: 1em;
            }
            
            /* Hide scrollbars but keep functionality */
            .tab-content::-webkit-scrollbar,
            .info-box::-webkit-scrollbar {
                width: 4px;
            }
            
            .tab-content::-webkit-scrollbar-thumb,
            .info-box::-webkit-scrollbar-thumb {
                background-color: rgba(0,0,0,0.2);
                border-radius: 4px;
            }
            
            /* Make covered and missed points stack vertically on mobile */
            .info-box .info-box-title + div > div {
                flex-direction: column;
            }
            
            .info-box .info-box-title + div > div > div {
                width: 100%;
                margin-bottom: 15px;
            }
        }

        /* Performance section layout */
        .performance-flex-container {
            display: flex;
            gap: 20px;
        }

        .performance-column {
            flex: 1;
        }

        /* Media query for mobile view of performance sections */
        @media (max-width: 768px) {
            .performance-flex-container {
                flex-direction: column;
            }
            
            .performance-column {
                width: 100%;
                margin-bottom: 20px;
            }
        }

        /* Domain score styles */
        .domain-score {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border: 2px solid #000;
            border-radius: 0px;
            box-shadow: 3px 3px 0px #000;
            font-size: 1.1em;
        }

        .domain-score span {
            font-size: 1.2em;
            font-weight: 800;
        }

        /* Domain remarks style */
        .domain-remarks {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fffef0;
            border: 2px dashed #000;
            border-radius: 0px;
            box-shadow: 3px 3px 0px #000;
            display: none; /* Hidden by default, shown when remarks exist */
        }

        .domain-remarks-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #000;
        }

        /* Media query for mobile responsiveness */
        @media (max-width: 768px) {
            .domain-score {
                padding: 8px;
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            .domain-score span {
                font-size: 1.1em;
            }
            
            .timestamp-selector {
                font-size: 0.8em;
                padding: 6px;
            }
        }

        /* Add CSS for the Performance button and lightbox */
        #performance-button {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 8px 15px;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        #performance-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }
        
        #performance-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        /* Performance Lightbox styles */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .lightbox-content {
            background-color: white;
            width: 80%;
            max-width: 900px;
            height: 80%;
            border-radius: 0px;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 3px solid #000;
            box-shadow: 10px 10px 0px #000;
        }

        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 3px solid #000;
            font-size: 24px;
            cursor: pointer;
            color: #000;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0px;
            background-color: #FFDE59;
            box-shadow: 3px 3px 0px #000;
        }
        
        .lightbox-close:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 0px #000;
        }
        
        .lightbox-close:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px #000;
        }
        
        .lightbox h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
        }

        /* Mobile styles for Performance button */
        @media (max-width: 768px) {
            #performance-button {
                display: none; /* Hide in mobile view, only show in sidebar */
            }
        }

        /* Add styles for report issue button */
        .floating-report-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            border-radius: 0px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .floating-report-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .floating-report-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        @media (max-width: 768px) {
            .floating-report-button {
                bottom: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Ensure it doesn't collide with other floating elements */
            .floating-clipboard-buttons {
                bottom: 80px; /* Move clipboard buttons up when on mobile */
            }
        }
    </style>
</head>
<body>
    <!-- Error Container -->
    <div id="errorContainer"></div>
    <!-- Success Container -->
    <div id="successContainer"></div>

    <!-- Floating Back Button for Practice Mode -->
    <button class="floating-back-button" id="floatingBackBtn">
         Back
    </button>

    <!-- Floating Clipboard Buttons -->
    <div class="floating-clipboard-buttons" id="floatingClipboardButtons" style="display: none;">
        <button class="clipboard-button candidate" id="candidateInfoBtn">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/>
            </svg>
            <span>Candidate<br>Info</span>
        </button>
        <button class="clipboard-button findings" id="findingsBtn">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-5-4v4h4V3h-4Z"/>
            </svg>
            <span>Findings</span>
        </button>
    </div>

    <!-- Candidate Info Lightbox -->
    <div class="content-lightbox" id="candidateInfoLightbox">
        <div class="content-lightbox-inner">
            <button class="content-lightbox-close">&times;</button>
            <div id="candidateInfoLightboxContent"></div>
        </div>
    </div>

    <!-- Findings Lightbox -->
    <div class="content-lightbox" id="findingsLightbox">
        <div class="content-lightbox-inner">
            <button class="content-lightbox-close">&times;</button>
            <div id="findingsLightboxContent"></div>
        </div>
    </div>

    <!-- Floating Report Issue Button -->
    <button class="floating-report-button" id="reportIssueBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12.435 12.435 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A19.626 19.626 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a19.587 19.587 0 0 0 1.349-.476l.019-.007.004-.002h.001"/>
        </svg>
        Report Issue
    </button>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Practice Mode Welcome Screen -->
    <div class="practice-welcome-screen">
        <h1 class="practice-welcome-title">Welcome to Practice Mode! </h1>
        <p class="practice-welcome-description">
            Your partner can be anyone who can speak English - a fellow student, friend, or family member!
        </p>
        <div class="practice-buttons">
            <button class="practice-button primary" id="practiceWithPartnerBtn">
                 Practice with Partner
            </button>
            <button class="practice-button" id="practiceWithAIBtn">
                 Practice with AI
            </button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; color: #000;">Generating Simulator Info...</h2>
        <p style="color: #666;">Please wait while we prepare your practice session.</p>
    </div>

    <!-- Simulator Link Screen -->
    <div class="simulator-link-screen">
        <h1 class="simulator-link-title">Practice Session Ready </h1>
        <div class="simulator-steps">
            <!-- Step 1: Share Link -->
            <div class="simulator-step">
                <div class="simulator-step-number">1</div>
                <div class="simulator-step-title">Share this link with your practice partner</div>
                <div class="simulator-step-content">
                    <div class="simulator-link-box" id="simulatorLinkBox"></div>
                    <div class="simulator-step-buttons">
                        <button class="simulator-button" id="copyLinkBtn">
                             Copy Link
                        </button>
                        <button class="simulator-button" id="shareLinkBtn">
                             Share Link
                        </button>
                    </div>
                    <div class="success-message" id="successMessage"></div>
                </div>
            </div>

            <!-- Step 2: Video Call -->
            <div class="simulator-step">
                <div class="simulator-step-number">2</div>
                <div class="simulator-step-title">Start video call (Optional)</div>
                <div class="simulator-step-content">
                    <p style="margin-bottom: 15px;">If practicing remotely, start a video call with your practice partner.</p>
                    <div class="simulator-step-buttons">
                        <button class="simulator-button" id="generateLinkButton2">
                             Start Video Call
                        </button>
                    </div>
                    
                    <!-- Jitsi Container - moved inside step 2 -->
                    <div id="jitsi-container" style="display: none; margin: 15px auto; position: relative; z-index: 1; width: 100%; box-sizing: border-box;">
                        <div id="loading-screen">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Begin Practice -->
            <div class="simulator-step">
                <div class="simulator-step-number">3</div>
                <div class="simulator-step-title">Begin practice session</div>
                <div class="simulator-step-content">
                    <p style="margin-bottom: 15px;">When you and your practice partner are ready, click the button below to start the reading time.</p>
                    <div class="simulator-step-buttons">
                        <button class="simulator-button primary" id="beginReadingTimeBtn">
                             Begin Reading Time
                        </button>
                        <!-- Back button removed from here and moved to floating position -->
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Topbar -->
    <div id="topbar">
        <div id="topbar-left">
            <button id="mobile-menu-button" class="mobile-menu-button">
                Menu
            </button>
            <button id="brainbank-button">
                
                BrainBank
            </button>
            <button id="performance-button">
                
                Performance
            </button>
        </div>
        <div id="topbar-center">
            <!-- Timer Widget moved to topbar -->
            <div id="timerWidget">
                <div id="expandedContent">
                    <div id="timerText">
                        <span id="time">01:30</span>
                        <br>
                        <span id="readingTimeLabel">Reading Time</span>
                    </div>
                    <div id="buttonContainer">
                        <button id="actionBtn" class="timer-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                        <button id="skipBtn" class="timer-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                                <line x1="19" y1="5" x2="19" y2="19"></line>
                            </svg>
                        </button>
                        <button id="resetBtn" class="timer-button">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 2v6h6"></path>
                                <path d="M21 12A9 9 0 006 5.3L3 8"></path>
                                <path d="M21 22v-6h-6"></path>
                                <path d="M3 12a9 9 0 0015 6.7l3-2.7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="expandedLabel">GMC 8-minute timer</div>
            </div>
        </div>
        <div id="topbar-right">
            <button class="mode-button active" id="modeToggleBtn">Switch to Practice Mode</button>
            <button class="mode-button" id="dashboardBtn">Dashboard</button>
        </div>
    </div>

    <!-- Mobile Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close" id="sidebar-close">&times;</button>
        <div class="sidebar-menu">
            <button class="sidebar-menu-button" id="sidebar-brainbank-button">
                 BrainBank
            </button>
            <button class="sidebar-menu-button" id="sidebar-performance-button">
                 Performance
            </button>
            <button class="sidebar-menu-button" id="sidebar-mode-toggle">
                Switch to Practice Mode
            </button>
            <button class="sidebar-menu-button" id="sidebar-dashboard">
                Dashboard
            </button>
        </div>
    </div>

    <!-- Lightbox for BrainBank -->
    <div id="lightbox">
        <div id="lightbox-content">
            <button id="lightbox-close"></button>
            <h2>BrainBank</h2>
            <!-- Add loading state -->
            <div id="lightbox-loading">
                <div class="spinner"></div>
            </div>
            <div id="lightbox-treeView" class="tree-view"></div>
        </div>
    </div>

    <!-- Add Performance Lightbox -->
    <div id="performance-lightbox" class="lightbox">
        <div id="performance-lightbox-content" class="lightbox-content">
            <button id="performance-lightbox-close" class="lightbox-close"></button>
            <h2>My Performance</h2>
            
            <div style="margin-bottom: 10px; text-align: center; font-size: 0.9em; background-color: #f8f9fa; padding: 8px;">
                DG: Data Gathering, MG: Management, IS: Interpersonal Skills
            </div>
            <select id="timestampSelector" class="timestamp-selector">
                <option value="">Select a timestamp</option>
            </select>
            
            <div id="no-performance-data" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border: 3px solid #000; border-radius: 0px; margin: 20px 0; box-shadow: 5px 5px 0px #000;">
                <h3 style="margin-bottom: 15px;">No Performance Data Available</h3>
                <p>Switch to Practice Mode and complete this case to see your performance data here.</p>
            </div>
            
            <div id="performance-sections">
                <div class="info-box">
                    <div class="info-box-title">Data Gathering</div>
                    <div style="padding: 10px;">
                        <div class="domain-score" id="dataGatheringScore">Score: N/A</div>
                        <div class="domain-remarks">
                            <div class="domain-remarks-title">Examiner's Remarks:</div>
                            <div id="dataGatheringRemarks"></div>
                        </div>
                        <div class="performance-flex-container">
                            <div class="performance-column">
                                <h4> Covered Points</h4>
                                <div id="dataGatheringCovered"></div>
                            </div>
                            <div class="performance-column">
                                <h4> Missed Points</h4>
                                <div id="dataGatheringMissed"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-box-title">Management</div>
                    <div style="padding: 10px;">
                        <div class="domain-score" id="managementScore">Score: N/A</div>
                        <div class="domain-remarks">
                            <div class="domain-remarks-title">Examiner's Remarks:</div>
                            <div id="managementRemarks"></div>
                        </div>
                        <div class="performance-flex-container">
                            <div class="performance-column">
                                <h4> Covered Points</h4>
                                <div id="managementCovered"></div>
                            </div>
                            <div class="performance-column">
                                <h4> Missed Points</h4>
                                <div id="managementMissed"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-box-title">Interpersonal Skills</div>
                    <div style="padding: 10px;">
                        <div class="domain-score" id="interpersonalSkillsScore">Score: N/A</div>
                        <div class="domain-remarks">
                            <div class="domain-remarks-title">Examiner's Remarks:</div>
                            <div id="interpersonalSkillsRemarks"></div>
                        </div>
                        <div class="performance-flex-container">
                            <div class="performance-column">
                                <h4> Covered Points</h4>
                                <div id="interpersonalSkillsCovered"></div>
                            </div>
                            <div class="performance-column">
                                <h4> Missed Points</h4>
                                <div id="interpersonalSkillsMissed"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="main-content">
            <div class="tab-container">
                <div class="tab-list">
                    <button class="tab-button active" data-tab="case-overview">
                        <span class="tab-icon"></span>
                        <span class="tab-label">Case Overview</span>
                    </button>
                    <button class="tab-button" data-tab="doctors-instructions">
                        <span class="tab-icon"></span>
                        <span class="tab-label">Doctor's Instructions</span>
                    </button>
                    <button class="tab-button" data-tab="simulator-info">
                        <span class="tab-icon"></span>
                        <span class="tab-label">Simulator/ Examiner Info</span>
                    </button>
                    <button class="tab-button" data-tab="consultation-guide">
                        <span class="tab-icon"></span>
                        <span class="tab-label">Consultation Guide</span>
                    </button>
                </div>
                
                <div class="tab-content">
                    <!-- Case Overview Tab -->
                    <div class="tab-panel active" id="case-overview">
                        <div class="info-box">
                            <div class="info-box-title">Key Points</div>
                            <div id="keyPoints"></div>
                        </div>
                    </div>

                    <!-- Doctor's Instructions Tab -->
                    <div class="tab-panel" id="doctors-instructions">
                        <div class="info-box">
                            <div class="info-box-title">Candidate Information</div>
                            <div class="candidate-info-grid">
                                <div class="candidate-info-item">
                                    <strong>Where are you?</strong>
                                    <div id="whereAreYou"></div>
                                </div>
                                <div class="candidate-info-item">
                                    <strong>Who is your patient?</strong>
                                    <div id="whoYourPatientIs"></div>
                                </div>
                                <div class="candidate-info-item">
                                    <strong>Other Information</strong>
                                    <div id="otherInformation"></div>
                                </div>
                                <div class="candidate-info-item">
                                    <strong>What you must do</strong>
                                    <div id="whatYouMustDo"></div>
                                </div>
                                <div class="candidate-info-item">
                                    <strong>Special Note</strong>
                                    <div id="specialNote"></div>
                                </div>
                            </div>
                        </div>
                        <div class="info-box">
                            <div class="info-box-title">Findings</div>
                            <img id="findingsImage" style="max-width: 100%; margin: 10px 0;">
                            <div id="findingsText"></div>
                        </div>
                    </div>

                    <!-- Simulator/Examiner Info Tab -->
                    <div class="tab-panel" id="simulator-info">
                        <div class="info-box">
                            <div class="info-box-title">Patient Information</div>
                            <div id="patientInfo"></div>
                        </div>
                        <div class="checkbox-group" id="dataGatheringCheckbox"></div>
                        <div class="checkbox-group" id="managementCheckbox"></div>
                        <div class="checkbox-group" id="interpersonalSkillsCheckbox"></div>
                    </div>

                    <!-- Consultation Guide Tab -->
                    <div class="tab-panel" id="consultation-guide">
                        <div class="sections" id="inTimeWidget">
                            <div class="section" id="section1">
                                <div class="section-title">08:00-07:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section2">
                                <div class="section-title">07:30-07:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section3">
                                <div class="section-title">07:00-06:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section4">
                                <div class="section-title">06:30-06:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section5">
                                <div class="section-title">06:00-05:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section6">
                                <div class="section-title">05:30-05:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section7">
                                <div class="section-title">05:00-04:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section8">
                                <div class="section-title">04:30-04:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section9">
                                <div class="section-title">04:00-03:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section10">
                                <div class="section-title">03:30-03:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section11">
                                <div class="section-title">03:00-02:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section12">
                                <div class="section-title">02:30-02:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section13">
                                <div class="section-title">02:00-01:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section14">
                                <div class="section-title">01:30-01:00</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section15">
                                <div class="section-title">01:00-00:30</div>
                                <div class="section-content"></div>
                            </div>
                            <div class="section" id="section16">
                                <div class="section-title">00:30-00:00</div>
                                <div class="section-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Suppress preload warning for Wix resources
    window.addEventListener('load', () => {
        const originalConsoleWarn = console.warn;
        console.warn = function() {
            // Skip warnings about preloaded resources from Wix domains
            if (arguments[0] && 
                typeof arguments[0] === 'string' && 
                (arguments[0].includes('preloaded using link preload') || 
                 arguments[0].includes('parastorage.com'))) {
                return;
            }
            originalConsoleWarn.apply(console, arguments);
        };
    });
    
    // State management
    let state = {
        mode: 'review',
        currentCase: null,
        timestamps: [],
        results: {
            dataGathering: { covered: [], missed: [] },
            management: { covered: [], missed: [] },
            interpersonalSkills: { covered: [], missed: [] }
        },
        loading: false,
        treeView: null
    };

    // Initialize TreeView instance
    document.addEventListener('DOMContentLoaded', () => {
        state.treeView = new TreeView(document.getElementById('lightbox-treeView'));
        
        // Initialize the TreeView mode to match the global state
        if (state.treeView && state.mode) {
            state.treeView.setMode(state.mode);
        }
        
        // BrainBank button functionality
        document.getElementById('brainbank-button').addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'flex';
            // Re-render the tree view when showing the lightbox
            if (state.treeView) {
                state.treeView.render();
            }
        });
        
        // Close lightbox
        document.getElementById('lightbox-close').addEventListener('click', () => {
            document.getElementById('lightbox').style.display = 'none';
        });
        
        // Also close lightbox when clicking outside content area
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target === document.getElementById('lightbox')) {
                document.getElementById('lightbox').style.display = 'none';
            }
        });
    });
    
    // Function to update both tree views simultaneously
    function updateBothTreeViews(data) {
        updateTreeView(data);
    }

    function closeCaseSelectionDialog() {
        // Find and remove the overlay if it exists
        const overlay = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
        if (overlay) {
            document.body.removeChild(overlay);
        }
    }

    function updateTreeView(data) {
        if (state.treeView) {
            state.treeView.setData(data);
        }
    }



    function updateTopicInTree(topic, data) {
        if (state.treeView && topic && data) {
            state.treeView.updateTopic(topic, data);
        } else {
            console.warn("Cannot update topic in tree: invalid parameters", { topic, dataExists: !!data });
        }
    }

    // Message handler
    window.addEventListener('message', function(event) {
        // Check if event.data exists and is an object
        if (!event.data || typeof event.data !== 'object') {
            // console.warn('Received message with invalid data format:', event.data); // Optional: Log malformed data
            return; // Ignore messages without proper data structure
        }

        const { type, data } = event.data;

        // Check if type is defined and is a string
        if (typeof type !== 'string' || type === '') {
            // console.warn('Received message with invalid or missing type:', event.data); // Optional: Log messages with invalid type
            return; // Ignore messages without a valid type
        }

        switch(type) {
            case 'setMode':
                if (data && data.mode) {
                    handleModeChange(data.mode);
                } else if (typeof mode === 'string') {
                    handleModeChange(mode);
                }
                break;
            
            case 'showCaseSelection':
                // Directly open the BrainBank lightbox instead of showing a dialog
                document.getElementById('lightbox').style.display = 'flex';
                break;
            
            case 'closeCaseSelection':
                closeCaseSelectionDialog();
                break;
            
            case 'setTreeData':
                updateTreeView(data);
                break;
            
            case 'updateTopic':
                if (data) {
                    if (data.topic && data.data) {
                        // New nested format
                        updateTopicInTree(data.topic, data.data);
                    } else {
                        // Old format
                        updateTopicInTree(topic, data);
                    }
                }
                break;
            

            
            case 'hideTimestampSelector':
                document.getElementById('timestampSelector').style.display = 'none';
                break;
            
            case 'showTimestampSelector':
                updateTimestampSelector(data);
                break;
            
            case 'setTimestampValue':
                if (data && data.value !== undefined) {
                    document.getElementById('timestampSelector').value = data.value;
                }
                break;
            
            case 'updateCaseData':
                updateAllCaseData(data);
                // Check if in practice mode and reset to welcome screen
                if (state.mode === 'practice') {
                    resetPracticeToWelcomeScreen();
                }
                break;
            
            case 'updateResults':
                if (data) {
                    updateResults(data);
                }
                break;
            
            case 'clearResults':
                clearAllResults();
                break;
            
            case 'updateInTime':
                updateInTimeSection(data);
                break;
            
            case 'showError':
                showError(data.message);
                break;

            case 'sectionsWidgetReady':
                // Handle sections widget ready event
                console.log('Sections widget is ready');
                // No further action needed for this message type
                break;
            
            case 'updateCheckboxes':
                updateCheckboxes(data.data);
                break;
                
            case 'openBrainbank':
                // Directly open the BrainBank lightbox
                document.getElementById('lightbox').style.display = 'flex';
                break;

            case 'showSuccess':
                showSuccess(data.message);
                break;
                
            case 'videoCallInfo':
                // Make sure the container is visible before starting Jitsi
                document.getElementById('jitsi-container').style.display = 'block';
                // Handle video call info and start Jitsi directly
                startJitsiMeet(data.roomName, data.displayName);
                break;

            case 'simulatorLinkGenerated':
                // Hide loading screen if it's active
                document.querySelector('.loading-screen').classList.remove('active');
                // Show simulator link screen
                document.querySelector('.simulator-link-screen').classList.add('active');
                document.querySelector('.practice-welcome-screen').classList.remove('active');
                
                // Show back button when on simulator link screen
                const floatingBackBtn = document.getElementById('floatingBackBtn');
                if (floatingBackBtn) {
                    floatingBackBtn.style.display = 'block';
                }
                
                const linkBox = document.getElementById('simulatorLinkBox');
                if (linkBox && event.data.link) {
                    linkBox.textContent = event.data.link;
                }
                break;

            default:
                // This now only logs if 'type' is a string but not matched by any case
                console.log('Received unhandled message type:', type, 'with data:', data);
        }
    });

    // Utility functions
    function showLoading() {
        state.loading = true;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        state.loading = false;
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showError(message) {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
        setTimeout(() => {
            errorContainer.style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        const successContainer = document.getElementById('successContainer');
        successContainer.textContent = message;
        successContainer.style.display = 'block';
        setTimeout(() => {
            successContainer.style.display = 'none';
        }, 5000);
    }

    // Handler functions
    function handleModeChange(mode) {
        state.mode = mode;
        document.body.className = `mode-${mode}`;
        
        // Update TreeView mode to match global state
        if (state.treeView) {
            state.treeView.setMode(mode);
        }
        
        // Update button state and text
        const modeToggleBtn = document.getElementById('modeToggleBtn');
        if (mode === 'review') {
            modeToggleBtn.classList.add('active');
            modeToggleBtn.textContent = 'Switch to Practice Mode';
            
            // Show review mode UI
            document.querySelector('.practice-welcome-screen').classList.remove('active');
            document.querySelector('.simulator-link-screen').classList.remove('active');
            document.querySelector('.main-content').style.display = 'block';
            
            // Hide back button in review mode
            const floatingBackBtn = document.getElementById('floatingBackBtn');
            if (floatingBackBtn) {
                floatingBackBtn.style.display = 'none';
            }
            
            // Simple fix to restore findings box visibility when switching to review mode
            const findingsBox = document.querySelector('#doctors-instructions .info-box:nth-child(2)');
            if (findingsBox) {
                findingsBox.style.display = 'block';
            }
            
            // Also ensure the findings image and text are visible
            const findingsImage = document.getElementById('findingsImage');
            const findingsText = document.getElementById('findingsText');
            if (findingsImage) findingsImage.style.display = '';
            if (findingsText) findingsText.style.display = 'block';
        } else {
            modeToggleBtn.classList.remove('active');
            modeToggleBtn.textContent = 'Switch to Review Mode';
            
            // Show practice mode UI
            document.querySelector('.practice-welcome-screen').classList.add('active');
            document.querySelector('.simulator-link-screen').classList.remove('active');
            document.querySelector('.main-content').style.display = 'none';
            
            // Hide back button when in practice mode and welcome screen is active
            const floatingBackBtn = document.getElementById('floatingBackBtn');
            if (floatingBackBtn) {
                floatingBackBtn.style.display = 'none';
            }
        }

        // Update sidebar mode toggle button
        const sidebarModeToggle = document.getElementById('sidebar-mode-toggle');
        if (sidebarModeToggle) {
            if (mode === 'review') {
                sidebarModeToggle.textContent = 'Switch to Practice Mode';
                sidebarModeToggle.classList.add('active');
            } else {
                sidebarModeToggle.textContent = 'Switch to Review Mode';
                sidebarModeToggle.classList.remove('active');
            }
        }
    }

    function updateAllCaseData(data) {
        showLoading();
        try {
            // Update candidate info
            if (data.candidateInfo) {
                updateCandidateInfo(data.candidateInfo);
            }
            
            // Update findings
            if (data.findingsImage) {
                document.getElementById('findingsImage').src = data.findingsImage;
                document.getElementById('findingsImage').style.display = 'block';
            } else {
                document.getElementById('findingsImage').style.display = 'none';
            }
            
            document.getElementById('findingsText').innerHTML = data.findingsText || '';
            document.getElementById('patientInfo').innerHTML = data.patientInfo || '';
            document.getElementById('keyPoints').innerHTML = data.keyPoints || '';
            
            // Update in-time sections
            if (data.inTimeSections) {
                updateInTimeContent(data.inTimeSections);
            }
            
            // Update checklist
            if (data.checklist) {
                updateChecklist(data.checklist);
            }
        } finally {
            hideLoading();
        }
    }

    function updateCandidateInfo(info) {
        document.getElementById('whereAreYou').textContent = info.whereAreYou || '';
        document.getElementById('whoYourPatientIs').textContent = info.whoYourPatientIs || '';
        document.getElementById('otherInformation').textContent = info.otherInformation || '';
        document.getElementById('whatYouMustDo').textContent = info.whatYouMustDo || '';
        document.getElementById('specialNote').textContent = info.specialNote || '';
    }

    function updateResults(results) {
        if (!results || Object.keys(results).length === 0) {
            // Show no data message and hide performance sections
            document.getElementById('no-performance-data').style.display = 'block';
            document.getElementById('performance-sections').style.display = 'none';
            document.getElementById('timestampSelector').style.display = 'none';
            return;
        }
        
        // Hide no data message and show performance sections
        document.getElementById('no-performance-data').style.display = 'none';
        document.getElementById('performance-sections').style.display = 'block';
        document.getElementById('timestampSelector').style.display = 'block';
        
        // Update the UI for each domain
        const domains = ['dataGathering', 'management', 'interpersonalSkills'];
        
        domains.forEach(domain => {
            const coveredList = document.getElementById(`${domain}Covered`);
            const missedList = document.getElementById(`${domain}Missed`);
            const scoreElement = document.getElementById(`${domain}Score`);
            const remarksElement = document.getElementById(`${domain}Remarks`);
            
            if (results[domain]) {
                if (coveredList) coveredList.innerHTML = createHTMLList(results[domain].covered || []);
                if (missedList) missedList.innerHTML = createHTMLList(results[domain].missed || []);
                
                // Update the score display
                if (scoreElement && results[domain].score) {
                    scoreElement.innerHTML = `Score: <span style="color: ${getScoreColor(results[domain].score)};">${results[domain].score}</span>`;
                } else if (scoreElement) {
                    scoreElement.innerHTML = 'Score: N/A';
                }
                
                // Update remarks if they exist
                if (remarksElement) {
                    if (results[domain].remarks) {
                        remarksElement.innerHTML = results[domain].remarks;
                        remarksElement.parentElement.style.display = 'block';
                    } else {
                        remarksElement.innerHTML = '';
                        remarksElement.parentElement.style.display = 'none';
                    }
                }
            } else {
                if (coveredList) coveredList.innerHTML = "<p>None</p>";
                if (missedList) missedList.innerHTML = "<p>None</p>";
                if (scoreElement) {
                    scoreElement.innerHTML = 'Score: N/A';
                }
                if (remarksElement) {
                    remarksElement.innerHTML = '';
                    remarksElement.parentElement.style.display = 'none';
                }
            }
        });
    }

    function getScoreColor(score) {
        // Convert score to number, ensuring it's parsed and rounded
        const numScore = typeof score === 'string' ? parseInt(score) : Math.round(score);
        if (isNaN(numScore)) return '#000000'; // Black for non-numeric
        
        if (numScore >= 3) return '#28a745'; // Green for good scores
        if (numScore >= 2) return '#fd7e14'; // Orange for medium scores
        return '#dc3545'; // Red for low scores
    }

    function clearAllResults() {
        // Show no data message and hide performance sections
        document.getElementById('no-performance-data').style.display = 'block';
        document.getElementById('performance-sections').style.display = 'none';
        document.getElementById('timestampSelector').style.display = 'none';
        
        ['dataGathering', 'management', 'interpersonalSkills'].forEach(domain => {
            document.getElementById(`${domain}Covered`).innerHTML = '';
            document.getElementById(`${domain}Missed`).innerHTML = '';
            
            const scoreElement = document.getElementById(`${domain}Score`);
            if (scoreElement) {
                scoreElement.innerHTML = 'Score: N/A';
            }
            
            // Clear remarks and hide remarks container
            const remarksElement = document.getElementById(`${domain}Remarks`);
            if (remarksElement) {
                remarksElement.innerHTML = '';
                remarksElement.parentElement.style.display = 'none';
            }
        });
    }

    function createHTMLList(items) {
        if (!items || items.length === 0) return "<p>None</p>";
        return "<ul>" + items.map(item => `<li>${item}</li>`).join("") + "</ul>";
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarBrainbankButton = document.getElementById('sidebar-brainbank-button');
        const sidebarModeToggle = document.getElementById('sidebar-mode-toggle');
        const sidebarDashboard = document.getElementById('sidebar-dashboard');
        const sidebarClose = document.getElementById('sidebar-close');

        // Function to toggle sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
            // Prevent scrolling when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Toggle sidebar when menu button is clicked
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', toggleSidebar);
        }

        // Close sidebar when overlay is clicked
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Close sidebar when close button is clicked
        if (sidebarClose) {
            sidebarClose.addEventListener('click', toggleSidebar);
        }

        // Handle sidebar button clicks
        if (sidebarBrainbankButton) {
            sidebarBrainbankButton.addEventListener('click', function() {
                toggleSidebar(); // Close sidebar
                document.getElementById('lightbox').style.display = 'flex';
                // Re-render the tree view when showing the lightbox
                if (state.treeView) {
                    state.treeView.render();
                }
            });
        }

        if (sidebarModeToggle) {
            sidebarModeToggle.addEventListener('click', function() {
                toggleSidebar(); // Close sidebar
                // Toggle between review and practice mode
                const newMode = state.mode === 'review' ? 'practice' : 'review';
                window.parent.postMessage({ type: 'modeChange', mode: newMode }, '*');
                
                // Update sidebar button text
                if (newMode === 'review') {
                    sidebarModeToggle.textContent = 'Switch to Practice Mode';
                    sidebarModeToggle.classList.add('active');
                } else {
                    sidebarModeToggle.textContent = 'Switch to Review Mode';
                    sidebarModeToggle.classList.remove('active');
                }
            });
        }

        // Update sidebar mode toggle button when mode changes
        function updateSidebarModeToggle(mode) {
            if (sidebarModeToggle) {
                if (mode === 'review') {
                    sidebarModeToggle.textContent = 'Switch to Practice Mode';
                    sidebarModeToggle.classList.add('active');
                } else {
                    sidebarModeToggle.textContent = 'Switch to Review Mode';
                    sidebarModeToggle.classList.remove('active');
                }
            }
        }

        // Mode switching
        document.getElementById('modeToggleBtn').addEventListener('click', () => {
            // Toggle between review and practice mode
            const newMode = state.mode === 'review' ? 'practice' : 'review';
            window.parent.postMessage({ type: 'modeChange', mode: newMode }, '*');
            
            // Update sidebar mode toggle
            updateSidebarModeToggle(newMode);
            
            // Hide back button when switching to practice mode if welcome screen is active
            if (newMode === 'practice') {
                const floatingBackBtn = document.getElementById('floatingBackBtn');
                if (floatingBackBtn && document.querySelector('.practice-welcome-screen.active')) {
                    floatingBackBtn.style.display = 'none';
                }
            }
        });

        // Dashboard button
        document.getElementById('dashboardBtn').addEventListener('click', () => {
            // Show loading overlay before navigation
            document.getElementById('loadingOverlay').style.display = 'flex';
            window.parent.postMessage({ type: 'navigate', data: { url: '/dashboard' } }, '*');
        });
        
        // Sidebar dashboard button
        if (sidebarDashboard) {
            sidebarDashboard.addEventListener('click', function() {
                toggleSidebar(); // Close sidebar
                // Show loading overlay before navigation
                document.getElementById('loadingOverlay').style.display = 'flex';
                window.parent.postMessage({ type: 'navigate', data: { url: '/dashboard' } }, '*');
            });
        }

        if (practiceWithAIBtn) {
            practiceWithAIBtn.addEventListener('click', () => {
                // Show loading overlay before navigation
                document.getElementById('loadingOverlay').style.display = 'flex';
                // The Wix code will append the current case name to the URL
                window.parent.postMessage({ 
                    type: 'navigate',
                    data: { url: '/patientgpt' }
                }, '*');
            });
        }
        
        // Tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and panels
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Show corresponding panel
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Timestamp selection
        const timestampSelector = document.getElementById('timestampSelector');
        if (timestampSelector) {
            timestampSelector.addEventListener('change', (e) => {
                window.parent.postMessage({ 
                    type: 'timestampChange', 
                    value: e.target.value 
                }, '*');
            });
        }
        
        // Generate link buttons
        document.getElementById('generateLinkButton2').addEventListener('click', () => {
            window.parent.postMessage({ type: 'getVideoCallInfo' }, '*');
        });

        // Practice mode buttons
        document.getElementById('practiceWithPartnerBtn').addEventListener('click', () => {
            document.querySelector('.practice-welcome-screen').classList.remove('active');
            document.querySelector('.loading-screen').classList.add('active');
            document.querySelector('.main-content').style.display = 'none';
            
            // Show back button when moving away from welcome screen
            document.getElementById('floatingBackBtn').style.display = 'block';
            
            // Ensure we're in practice mode and TreeView knows it
            if (state.mode !== 'practice') {
                handleModeChange('practice');
            } else if (state.treeView) {
                state.treeView.setMode('practice');
            }
            
            // Automatically request link generation
            window.parent.postMessage({ type: 'generateLink' }, '*');
        });

        // Copy and Share buttons
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const successMessage = document.getElementById('successMessage');
        const generateLinkButton2 = document.getElementById('generateLinkButton2');
        const beginReadingTimeBtn = document.getElementById('beginReadingTimeBtn');
        const floatingBackBtn = document.getElementById('floatingBackBtn');

        // Hide back button on welcome screen
        if (floatingBackBtn && document.querySelector('.practice-welcome-screen.active')) {
            floatingBackBtn.style.display = 'none';
        }

        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', () => {
                const linkBox = document.getElementById('simulatorLinkBox');
                if (linkBox && linkBox.textContent) {
                    window.parent.postMessage({ 
                        type: 'copyToClipboard',
                        text: linkBox.textContent
                    }, '*');
                    if (successMessage) {
                        successMessage.textContent = ' Link copied to clipboard!';
                        successMessage.style.display = 'block';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 3000);
                    }
                }
            });
        }

        if (shareLinkBtn) {
            shareLinkBtn.addEventListener('click', () => {
                const linkBox = document.getElementById('simulatorLinkBox');
                if (linkBox && linkBox.textContent && navigator.share) {
                    navigator.share({
                        title: 'OSCE Practice Simulator Info',
                        text: 'Here is the simulator information for our OSCE practice session:',
                        url: linkBox.textContent
                    }).catch(console.error);
                } else if (copyLinkBtn) {
                    // Fallback to copy if Web Share API is not available
                    copyLinkBtn.click();
                }
            });
        }

        // Set up floating back button functionality
        if (floatingBackBtn) {
            floatingBackBtn.addEventListener('click', () => {
                // Reset the practice screen to initial state
                
                // 1. Reset and clear timer
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.click(); // Use the existing reset functionality
                }
                
                // 2. Clear any dynamically added elements from the simulator screen
                const simulatorLinkScreen = document.querySelector('.simulator-link-screen');
                if (simulatorLinkScreen) {
                    // Remove any dynamically added top candidate info and enter room button
                    const topCandidateInfo = simulatorLinkScreen.querySelector('.top-candidate-info');
                    if (topCandidateInfo) {
                        simulatorLinkScreen.removeChild(topCandidateInfo);
                    }
                    
                    // Remove any findings box that was added
                    const findingsBoxes = simulatorLinkScreen.querySelectorAll('.info-box');
                    findingsBoxes.forEach(box => {
                        const title = box.querySelector('.info-box-title');
                        if (title && title.textContent.trim() === 'Findings') {
                            simulatorLinkScreen.removeChild(box);
                        }
                    });
                    
                    // Remove any dynamically added "Enter Room" button
                    const enterRoomBtn = simulatorLinkScreen.querySelector('#enterRoomBtn');
                    if (enterRoomBtn) {
                        simulatorLinkScreen.removeChild(enterRoomBtn);
                    }
                    
                    // Reset simulator-link-title visibility
                    const simulatorLinkTitle = simulatorLinkScreen.querySelector('.simulator-link-title');
                    if (simulatorLinkTitle) {
                        simulatorLinkTitle.style.display = '';
                    }
                    
                    // Make all simulator steps visible again and restore step numbers
                    const simulatorSteps = simulatorLinkScreen.querySelectorAll('.simulator-step');
                    simulatorSteps.forEach(step => {
                        step.style.display = '';
                        const stepNumber = step.querySelector('.simulator-step-number');
                        if (stepNumber) {
                            stepNumber.style.display = '';
                        }
                    });
                }
                
                // 3. Clear any Jitsi session
                clearJitsiMeet();
                
                // 4. Hide the jitsi container
                const jitsiContainer = document.getElementById('jitsi-container');
                if (jitsiContainer) {
                    jitsiContainer.style.display = 'none';
                }
                
                // 5. Re-enable the "Start Video Call" button
                const generateLinkButton2 = document.getElementById('generateLinkButton2');
                if (generateLinkButton2) {
                    generateLinkButton2.style.display = 'block';
                }
                
                // 6. Hide clipboard buttons and reset lightboxes
                const floatingClipboardButtons = document.getElementById('floatingClipboardButtons');
                if (floatingClipboardButtons) {
                    floatingClipboardButtons.style.display = 'none';
                }
                
                // Reset and hide lightboxes
                document.querySelectorAll('.content-lightbox').forEach(lightbox => {
                    lightbox.style.display = 'none';
                });
                
                // 7. Return to welcome screen
                document.querySelector('.simulator-link-screen').classList.remove('active');
                document.querySelector('.practice-welcome-screen').classList.add('active');
                document.querySelector('.main-content').style.display = 'none';
                
                // Hide back button when returning to welcome screen
                floatingBackBtn.style.display = 'none';
            });
        }

        if (generateLinkButton2) {
            generateLinkButton2.addEventListener('click', () => {
                window.parent.postMessage({ type: 'getVideoCallInfo' }, '*');
            });
        }

        if (beginReadingTimeBtn) {
            beginReadingTimeBtn.addEventListener('click', () => {
                // Hide only step 3 container
                const simulatorSteps = document.querySelectorAll('.simulator-step');
                if (simulatorSteps.length >= 3) {
                    simulatorSteps[2].style.display = 'none';
                }
                
                // Hide the simulator link title
                const simulatorLinkTitle = document.querySelector('.simulator-link-title');
                if (simulatorLinkTitle) {
                    simulatorLinkTitle.style.display = 'none';
                }
                
                // Get the simulator-link-screen
                const simulatorLinkScreen = document.querySelector('.simulator-link-screen');
                if (simulatorLinkScreen) {
                    // Remove any existing top candidate info to avoid duplicates
                    const existingTopInfo = simulatorLinkScreen.querySelector('.top-candidate-info');
                    if (existingTopInfo) {
                        simulatorLinkScreen.removeChild(existingTopInfo);
                    }
                    
                    // Remove any existing "Enter Room" button to avoid duplicates
                    const existingEnterRoomBtn = simulatorLinkScreen.querySelector('#enterRoomBtn');
                    if (existingEnterRoomBtn) {
                        simulatorLinkScreen.removeChild(existingEnterRoomBtn);
                    }
                    
                    // Create a new candidate info box directly instead of cloning
                    const newCandidateInfoBox = document.createElement('div');
                    newCandidateInfoBox.className = 'info-box top-candidate-info';
                    
                    // Create the title
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'info-box-title';
                    titleDiv.textContent = 'Candidate Information';
                    newCandidateInfoBox.appendChild(titleDiv);
                    
                    // Create the grid
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'candidate-info-grid';
                    
                    // Add content from the original elements
                    const whereAreYou = document.getElementById('whereAreYou')?.textContent || '';
                    const whoYourPatientIs = document.getElementById('whoYourPatientIs')?.textContent || '';
                    const otherInformation = document.getElementById('otherInformation')?.textContent || '';
                    const whatYouMustDo = document.getElementById('whatYouMustDo')?.textContent || '';
                    
                    // Create info items
                    const infoItems = [
                        { label: 'Where are you?', content: whereAreYou },
                        { label: 'Who is your patient?', content: whoYourPatientIs },
                        { label: 'Other Information', content: otherInformation },
                        { label: 'What you must do', content: whatYouMustDo }
                    ];
                    
                    // Add each info item to the grid
                    infoItems.forEach(item => {
                        if (item.content) {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'candidate-info-item';
                            
                            const strongEl = document.createElement('strong');
                            strongEl.textContent = item.label;
                            itemDiv.appendChild(strongEl);
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.textContent = item.content;
                            itemDiv.appendChild(contentDiv);
                            
                            gridDiv.appendChild(itemDiv);
                        }
                    });
                    
                    newCandidateInfoBox.appendChild(gridDiv);
                    
                    // Insert at the beginning of simulator-link-screen
                    simulatorLinkScreen.insertBefore(newCandidateInfoBox, simulatorLinkScreen.firstChild);
                    
                    // Create and add the "Enter the Room" button under the candidate info
                    const enterRoomButton = document.createElement('button');
                    enterRoomButton.id = 'enterRoomBtn';
                    enterRoomButton.className = 'simulator-button primary';
                    enterRoomButton.textContent = ' Enter the Room';
                    
                    // Insert the button after the candidate info box
                    simulatorLinkScreen.insertBefore(enterRoomButton, newCandidateInfoBox.nextSibling);
                }
                
                // Scroll to the top of the simulator screen
                scrollToSimulatorTop();
                
                // Start the reading time
                const actionBtn = document.getElementById('actionBtn');
                if (actionBtn) {
                    actionBtn.click(); // Trigger the timer to start
                }
            });
        }

        // Add event listener for the "Enter the Room" button
        // This will be attached dynamically since the button is created dynamically
        document.addEventListener('click', function(event) {
            if (event.target && event.target.id === 'enterRoomBtn') {
                // 1. Hide steps 1 and 3, but keep step 2 (video call) visible
                const simulatorSteps = document.querySelectorAll('.simulator-step');
                simulatorSteps.forEach((step, index) => {
                    if (index !== 1) {
                        step.style.display = 'none';
                    } else {
                        // For step 2, hide its step number but keep the step visible
                        const stepNumber = step.querySelector('.simulator-step-number');
                        if (stepNumber) {
                            stepNumber.style.display = 'none';
                        }
                    }
                });
                
                // 2. Instead of showing the boxes directly, clone their content to the lightboxes
                const candidateInfoBox = document.querySelector('.top-candidate-info');
                const candidateInfoLightboxContent = document.getElementById('candidateInfoLightboxContent');
                
                if (candidateInfoBox && candidateInfoLightboxContent) {
                    candidateInfoLightboxContent.innerHTML = candidateInfoBox.innerHTML;
                    
                    // Hide the original box
                    candidateInfoBox.style.display = 'none';
                }
                
                // For findings
                let findingsBox = null;
                const findingsLightboxContent = document.getElementById('findingsLightboxContent');
                const infoBoxTitles = document.querySelectorAll('.info-box-title');
                
                for (let i = 0; i < infoBoxTitles.length; i++) {
                    if (infoBoxTitles[i].textContent.trim() === 'Findings') {
                        findingsBox = infoBoxTitles[i].closest('.info-box');
                        break;
                    }
                }
                
                if (findingsBox && findingsLightboxContent) {
                    // Clone the findings content to the lightbox
                    findingsLightboxContent.innerHTML = findingsBox.innerHTML;
                    
                    // If this was added to the DOM, hide it
                    if (findingsBox.parentNode) {
                        findingsBox.style.display = 'none';
                    }
                } else if (findingsLightboxContent) {
                    // Create new content with findings image and text
                    findingsLightboxContent.innerHTML = '';
                    
                    const findingsImage = document.getElementById('findingsImage')?.cloneNode(true);
                    const findingsText = document.getElementById('findingsText')?.cloneNode(true);
                    
                    if (findingsImage) findingsLightboxContent.appendChild(findingsImage);
                    if (findingsText) findingsLightboxContent.appendChild(findingsText);
                }
                
                // Show the floating clipboard buttons
                const floatingClipboardButtons = document.getElementById('floatingClipboardButtons');
                if (floatingClipboardButtons) {
                    floatingClipboardButtons.style.display = 'flex';
                }
                
                // Scroll to the top of the simulator screen
                scrollToSimulatorTop();
                
                // 3. Start the main timer
                const skipBtn = document.getElementById('skipBtn');
                if (skipBtn) {
                    skipBtn.click(); // This will stop reading timer and start main timer
                }
                
                // Hide the Enter Room button itself
                event.target.style.display = 'none';
            }
        });
        
        // Function to scroll the simulator-link-screen to the top
        function scrollToSimulatorTop() {
            const simulatorLinkScreen = document.querySelector('.simulator-link-screen');
            if (simulatorLinkScreen) {
                simulatorLinkScreen.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        }

        // Performance button functionality
        const performanceButton = document.getElementById('performance-button');
        const performanceLightbox = document.getElementById('performance-lightbox');
        const performanceLightboxClose = document.getElementById('performance-lightbox-close');
        const sidebarPerformanceButton = document.getElementById('sidebar-performance-button');
        
        if (performanceButton) {
            performanceButton.addEventListener('click', function() {
                performanceLightbox.style.display = 'flex';
            });
        }
        
        if (sidebarPerformanceButton) {
            sidebarPerformanceButton.addEventListener('click', function() {
                toggleSidebar(); // Close sidebar
                performanceLightbox.style.display = 'flex';
            });
        }
        
        if (performanceLightboxClose) {
            performanceLightboxClose.addEventListener('click', function() {
                performanceLightbox.style.display = 'none';
            });
        }
        
        // Close lightbox when clicking outside content
        if (performanceLightbox) {
            performanceLightbox.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        }
        
        // Initialize feedback button
        const reportIssueBtn = document.getElementById('reportIssueBtn');
        if (reportIssueBtn) {
            reportIssueBtn.addEventListener('click', function() {
                // Show loading overlay before navigation
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                // Navigate to the feedback page within the application
                window.parent.postMessage({ 
                    type: 'navigate', 
                    data: { url: '/user-feedback' } 
                }, '*');
            });
        }
    });

    (function() {
        function updateActiveSection(activeSection) {
            for (var i = 1; i <= 16; i++) {
                var section = document.getElementById('section' + i);
                if (i === activeSection) {
                    section.classList.add('active');
                    scrollToSection(section);
                } else {
                    section.classList.remove('active');
                }
            }
        }
        function scrollToSection(section) {
            const container = document.querySelector('.container');
            const sectionRect = section.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const scrollTo = container.scrollTop + sectionRect.top - containerRect.top - (containerRect.height / 2) + (sectionRect.height / 2);
            
            container.scrollTo({
                top: scrollTo,
                behavior: 'smooth'
            });
        }

        function resetSections() {
            for (var i = 1; i <= 16; i++) {
                document.getElementById('section' + i).classList.remove('active');
            }
        }

        function loadContentFromCMS(content) {
            for (let i = 1; i <= 16; i++) {
                const sectionContent = document.querySelector(`#section${i} .section-content`);
                sectionContent.innerHTML = content[i-1];
            }
        }

        // Listen for messages from the parent window
        window.addEventListener('message', function(event) {
            if (!event.data || !event.data.type) return;
            
            if (event.data.type === 'updateActiveSection') {
                updateActiveSection(event.data.section);
            } else if (event.data.type === 'resetSections') {
                resetSections();
            } else if (event.data.type === 'loadContent') {
                loadContentFromCMS(event.data.content);
            }
        });

        // Only notify parent if we're in an iframe
        if (window.parent !== window) {
            // Notify parent that the widget is ready
            window.parent.postMessage({type: 'sectionsWidgetReady'}, '*');
        }
    })();
    class TreeView {
        constructor(element) {
            this.element = element;
            this.data = null;
            this.mode = 'review'; // Default mode
            this.selectedIds = []; // Track selected items by their ids
            
            // Show loading state initially
            document.getElementById('lightbox-loading').style.display = 'flex';
        }

        setData(data) {
            // Add open: false to all items in the tree
            this.data = this.addOpenStateToItems(data);
            this.render();
            // Hide loading state after data is set
            document.getElementById('lightbox-loading').style.display = 'none';
        }

        addOpenStateToItems(items) {
            if (!Array.isArray(items)) return items;
            return items.map(item => ({
                ...item,
                open: false,
                children: item.children ? this.addOpenStateToItems(item.children) : null
            }));
        }

        toggleTopic(topicId) {
            const closeAllTopicsExcept = (items, exceptId) => {
                if (!Array.isArray(items)) return;
                
                items.forEach(item => {
                    if (item.type === 'topic' && item.id !== exceptId) {
                        item.open = false;
                    }
                    if (item.children) {
                        closeAllTopicsExcept(item.children, exceptId);
                    }
                });
            };

            const toggleItemOpen = (items) => {
                if (!Array.isArray(items)) return false;
                
                for (let item of items) {
                    if (item.id === topicId) {
                        // Only close other topics if this is a top-level topic
                        if (!item.open && item.type === 'topic') {
                            closeAllTopicsExcept(this.data, topicId);
                        }
                        item.open = !item.open;
                        return true;
                    }
                    if (item.children && toggleItemOpen(item.children)) {
                        return true;
                    }
                }
                return false;
            };

            toggleItemOpen(this.data);
            this.render();
        }

        // Add function to set selected item and its parents
        setSelected(id) {
            // Reset selected items array
            this.selectedIds = [];
            
            // Find the item and its ancestors
            const findAndMarkSelected = (items, targetId, parentPath = []) => {
                if (!Array.isArray(items)) return false;
                
                for (let item of items) {
                    const currentPath = [...parentPath, item.id];
                    
                    if (item.id === targetId) {
                        // We found the target, mark its path as selected
                        this.selectedIds = currentPath;
                        return true;
                    }
                    
                    // Check children
                    if (item.children && findAndMarkSelected(item.children, targetId, currentPath)) {
                        return true;
                    }
                }
                return false;
            };
            
            findAndMarkSelected(this.data, id);
            this.render();
        }

        render() {
            this.element.innerHTML = this.renderTree(this.data);
            this.addEventListeners();
        }

        renderTree(items) {
            if (!items) return '';
            return items.map(item => this.renderItem(item)).join('');
        }

        renderItem(item) {
            const lockedClass = item.locked ? 'locked' : '';
            const selectedClass = this.selectedIds.includes(item.id) ? 'selected' : '';

            if (item.type === 'caseName') {
                const displayName = this.mode === 'practice' ? this.maskCaseName(item) : item.name;
                return `
                    <div class="case-item ${selectedClass}" data-id="${item.id}">
                        <span>${displayName}</span>
                        ${item.hasResponse ? '<span class="tick-mark"></span>' : ''}
                    </div>
                `;
            }

            const isOpen = item.open || (item.id === this.currentTopic);
            const childrenContent = item.children ? this.renderTree(item.children) : '';
            const hasChildren = item.children && item.children.length > 0;

            return `
                <div class="tree-item ${isOpen ? 'open' : ''}" data-id="${item.id}">
                    <div class="tree-item-header ${lockedClass} ${selectedClass}">
                        ${hasChildren ? `
                            <svg class="tree-item-icon" viewBox="0 0 24 24">
                                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                            </svg>
                        ` : ''}
                        ${item.name}
                        ${item.locked ? `
                            <svg class="lock-icon" viewBox="0 0 24 24">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                        ` : ''}
                    </div>
                    ${hasChildren ? `
                        <div class="tree-item-content">
                            ${childrenContent}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        maskCaseName(item) {
            return `Case ${item.caseUID}`;
        }



        addEventListeners() {
            this.element.querySelectorAll('.tree-item-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const item = header.closest('.tree-item');
                    if (!item) return;
                    
                    const id = item.dataset.id;
                    if (!id) return;
                    
                    // Find the item in the data
                    let foundItem = this.findItemById(this.data, id);
                    
                    // If the item is locked, don't do anything
                    if (foundItem && foundItem.locked) {
                        console.log("Topic is locked:", id);
                        return;
                    }
                    
                    // Toggle the item's open state
                    this.toggleTopic(id);
                    e.stopPropagation();
                });
            });

            this.element.querySelectorAll('.case-item').forEach(caseItem => {
                caseItem.addEventListener('click', (e) => {
                    const caseName = caseItem.dataset.id;
                    if (caseName) {
                        document.getElementById('lightbox-loading').style.display = 'flex';
                        this.setSelected(caseName); // Mark this case as selected
                        this.onCaseSelected(caseName);
                    }
                    e.stopPropagation();
                });
            });
        }

        findItemById(items, id) {
            if (!Array.isArray(items)) return null;
            
            for (let item of items) {
                if (item.id === id) return item;
                if (item.children) {
                    const found = this.findItemById(item.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        onCaseSelected(caseName) {
            window.parent.postMessage({ type: 'caseSelected', caseName: caseName }, '*');
        }

        setMode(mode) {
            this.mode = mode;
            this.render();
        }
    }

    const treeView = new TreeView(document.getElementById('lightbox-treeView'));
    window.addEventListener('message', (event) => {
        if (!event.data || !event.data.type) return;
        
        const { type, data, mode, topicId } = event.data;
        
        if (type === 'setData') {
            treeView.setData(data);
        } else if (type === 'toggleTopic') {
            treeView.toggleTopic(topicId);
        } else if (type === 'setMode' && mode) {
            treeView.setMode(mode);
        } else if (type === 'updateCaseData') {
            // Set selected case in the tree
            if (data && data.caseId) {
                treeView.setSelected(data.caseId);
            }
            // Hide loading state and close lightbox after case data is loaded
            document.getElementById('lightbox-loading').style.display = 'none';
            document.getElementById('lightbox').style.display = 'none';
        } else if (type === 'setSelectedItem') {
            // New event to directly set a selected item
            if (data && data.id) {
                treeView.setSelected(data.id);
            }
        }
    }, false);
    (function() {
        var timeDisplay, timerText, actionBtn, resetBtn, timerWidget, readingTimeLabel;
        var interval;
        var flashInterval;
        var totalTime = 90; // Initial 1:30 reading time
        var mainTimerTime = 480; // 8 minutes for the main timer
        var isRunning = false;
        var isMainTimerActive = false;
        var pausedTime = 0;
        var hasMainTimerStarted = false; // New variable to track if main timer has started

        function initializeTimer() {
            timeDisplay = document.getElementById('time');
            timerText = document.getElementById('timerText');
            actionBtn = document.getElementById('actionBtn');
            skipBtn = document.getElementById('skipBtn');
            resetBtn = document.getElementById('resetBtn');
            timerWidget = document.getElementById('timerWidget');
            readingTimeLabel = document.getElementById('readingTimeLabel');
            
            // No longer minimizing the timer as it's in the topbar
            timerWidget.classList.remove('minimized');
            
            skipBtn.disabled = true;
            skipBtn.style.opacity = '0.5';
            skipBtn.style.cursor = 'not-allowed';
          
            actionBtn.onclick = function(event) {
                event.stopPropagation();
                if (!isRunning) {
                    if (!isMainTimerActive) {
                        startPreliminaryTimer();
                        skipBtn.disabled = false;
                        skipBtn.style.opacity = '1';
                        skipBtn.style.cursor = 'pointer';
                    } else {
                        startMainTimer();
                    }
                    setActionButtonIcon('pause');
                    isRunning = true;
                } else if (isMainTimerActive) {
                    // Only allow pausing during the main timer
                    clearInterval(interval);
                    pausedTime = totalTime;
                    setActionButtonIcon('play');
                    isRunning = false;
                } else {
                    // Visual feedback that pausing is not allowed during reading time
                    timerWidget.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
                    setTimeout(() => {
                        timerWidget.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                    }, 300);
                }
            };

            skipBtn.onclick = function(event) {
                event.stopPropagation();
                if (!isMainTimerActive) {
                    clearInterval(interval);
                    startMainTimer();
                }
            };

            resetBtn.onclick = function(event) {
                event.stopPropagation();
                resetTimer();
            };
            
            // Remove click handler for minimize as it's now fixed in topbar
            timerWidget.onclick = null;
        }

        function startPreliminaryTimer() {
            totalTime = 90;
            skipBtn.style.display = 'inline-block';
            isMainTimerActive = false;
            interval = setInterval(function() {
                updateTimerDisplay(--totalTime);
                if (totalTime <= 0) {
                    clearInterval(interval);
                    
                    // Instead of directly starting main timer, only click the Enter Room button
                    // which will handle starting the main timer through its established logic
                    const enterRoomBtn = document.getElementById('enterRoomBtn');
                    if (enterRoomBtn) {
                        enterRoomBtn.click();
                    } else {
                        // Only start main timer directly if Enter Room button doesn't exist
                        startMainTimer();
                    }
                }
            }, 1000);
            playAudio('https://rohityenukoti.github.io/plab2timer/begin.mp3');
        }

        function startMainTimer() {
            totalTime = pausedTime > 0 ? pausedTime : mainTimerTime;
            pausedTime = 0;
            skipBtn.style.display = 'none';
            isMainTimerActive = true;
            readingTimeLabel.textContent = 'Consultation Time';
            updateTimerDisplay(totalTime);
            updateVisualIndicator();
            interval = setInterval(updateMainTimer, 1000);
            setActionButtonIcon('pause');
            if (!hasMainTimerStarted) {
                playAudio('https://rohityenukoti.github.io/plab2timer/Enter_room.mp3');
                hasMainTimerStarted = true;
            }
        }

        function updateMainTimer() {
            updateTimerDisplay(--totalTime);
            updateVisualIndicator();
            
            // Directly update sections based on elapsed time
            if (isMainTimerActive) {
                var elapsedTime = 480 - totalTime;
                var activeSection = Math.floor(elapsedTime / 30) + 1;
                activeSection = Math.min(activeSection, 16);
                
                // Update sections directly
                updateActiveSection(activeSection);
            }
            
            if (totalTime <= 0) {
                clearInterval(interval);
                resetTimer();
            }
        }

        function updateTimerDisplay(time) {
            var minutes = Math.floor(time / 60);
            var seconds = time % 60;
            timeDisplay.textContent = (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
        }

        function updateVisualIndicator() {
            if (totalTime === 240) {
                timerWidget.style.borderColor = 'lightgreen';
            } else if (totalTime <= 120) {
                flashTimer();
                if (totalTime === 120) {
                    playAudio('https://rohityenukoti.github.io/plab2timer/2minutewarning.mp3');
                } else if (totalTime === 1) {
                    playAudio('https://rohityenukoti.github.io/plab2timer/ending.mp3');
                }
            } else if (totalTime > 240) {
                timerWidget.style.borderColor = 'rgb(173, 216, 230)';
            }
        }

        function updateSections() {
            if (isMainTimerActive) {
                var elapsedTime = 480 - totalTime;
                var activeSection = Math.floor(elapsedTime / 30) + 1;
                activeSection = Math.min(activeSection, 16);
                
                window.parent.postMessage({type: 'updateActiveSection', section: activeSection}, '*');
            }
        }

        function resetTimer() {
            clearInterval(interval);
            clearInterval(flashInterval);
            skipBtn.style.display = 'inline-block';
            flashInterval = null;
            interval = null;
            totalTime = 90;
            mainTimerTime = 480;
            pausedTime = 0;
            updateTimerDisplay(totalTime);
            readingTimeLabel.textContent = 'Reading Time';
            timerWidget.style.borderColor = 'rgba(255, 255, 255, 0.9)';
            setActionButtonIcon('play');
            isRunning = false;
            isMainTimerActive = false;
            hasMainTimerStarted = false; // Reset this variable
          
            skipBtn.disabled = true;
            skipBtn.style.opacity = '0.5';
            skipBtn.style.cursor = 'not-allowed';
            
            // Reset sections directly
            resetSections();
        }

        function flashTimer() {
            if (!flashInterval) {
                flashInterval = setInterval(() => {
                    timerWidget.style.borderColor = timerWidget.style.borderColor === 'rgba(255, 255, 255, 0.9)' ? '#ffa500' : 'rgba(255, 255, 255, 0.9)';
                }, 500);
            }
        }

        function playAudio(url) {
            var audio = new Audio(url);
            audio.play();
        }

        function setActionButtonIcon(action) {
            const iconSVG = action === 'play' 
                ? '<polygon points="5 3 19 12 5 21 5 3"></polygon>'
                : '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
            
            actionBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${iconSVG}</svg>`;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTimer);
        } else {
            initializeTimer();
        }
    })();
    let currentApi = null; // Store reference to current Jitsi API instance

    function clearJitsiMeet() {
        if (currentApi) {
            currentApi.dispose();
            currentApi = null;
            
            // Clear the container contents
            const jitsiContainer = document.getElementById('jitsi-container');
            jitsiContainer.innerHTML = '';
            
            // Only recreate the loading spinner
            jitsiContainer.innerHTML = `
                <div id="loading-screen">
                    <div class="spinner"></div>
                </div>
            `;
            
            // Don't hide the container here - we'll let the calling function control visibility
            
            // Reattach event listener to the new button
            document.getElementById('generateLinkButton2').addEventListener('click', function() {
                window.parent.postMessage({ type: 'getVideoCallInfo' }, '*');
            });
        }
    }

    function startJitsiMeet(roomName, displayName) {
        // Make the jitsi container visible first and ensure it stays visible
        const jitsiContainer = document.getElementById('jitsi-container');
        jitsiContainer.style.display = 'block';
        
        // Hide the video call button
        const videoCallButton = document.getElementById('generateLinkButton2');
        if (videoCallButton) {
            videoCallButton.style.display = 'none';
        }
        
        // Show loading screen
        document.getElementById('loading-screen').style.display = 'flex';

        // Clear any existing meeting first
        if (currentApi) {
            clearJitsiMeet();
            // Re-show the container since clearJitsiMeet might hide it
            jitsiContainer.style.display = 'block';
        }

        const domain = "jitsi.dorf-post.de";
        const options = {
            roomName: roomName,
            width: '100%',
            height: '100%',
            parentNode: jitsiContainer,
            configOverwrite: {
                logging: {
                    defaultLogLevel: 'error',
                    loggers: {
                        'modules/RTC/TraceablePeerConnection.js': 'error',
                        'modules/xmpp/strophe.util.js': 'error',
                    },
                },
                prejoinConfig: {
                    enabled: false
                },
                deeplinking: {
                    disabled: true
                }
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 
                    'fullscreen', 'fodeviceselection', 'hangup', 'profile', 
                    'chat', 'recording', 'livestreaming', 'etherpad', 
                    'sharedvideo', 'settings', 'raisehand', 'videoquality', 
                    'filmstrip', 'feedback', 'stats', 'shortcuts',
                    'tileview', 'videobackgroundblur', 'download', 'help',
                    'mute-everyone', 'security'
                ]
            }
        };
        
        currentApi = new JitsiMeetExternalAPI(domain, options);
        currentApi.executeCommand('displayName', displayName);

        currentApi.addEventListener('videoConferenceLeft', () => {
            clearJitsiMeet();
            // Now that the user has actually left the conference, hide the container
            document.getElementById('jitsi-container').style.display = 'none';
            // Show the video call button again
            const videoCallButton = document.getElementById('generateLinkButton2');
            if (videoCallButton) {
                videoCallButton.style.display = 'block';
            }
        });

        // Hide loading screen once the meeting is joined
        currentApi.addEventListener('videoConferenceJoined', () => {
            document.getElementById('loading-screen').style.display = 'none';
        });
    }


    // Add this new function to handle the checklist data
    function updateCheckboxes(domainGroups) {
        // Clear existing content
        document.getElementById('dataGatheringCheckbox').innerHTML = '';
        document.getElementById('managementCheckbox').innerHTML = '';
        document.getElementById('interpersonalSkillsCheckbox').innerHTML = '';
        
        // Create info box container
        const infoBox = document.createElement('div');
        infoBox.className = 'info-box';
        infoBox.style.marginBottom = '20px';
        document.getElementById('dataGatheringCheckbox').appendChild(infoBox);
        
        // Add main heading as info-box-title
        const mainHeading = document.createElement('div');
        mainHeading.className = 'info-box-title';
        mainHeading.textContent = 'Examiners Checklist';
        infoBox.appendChild(mainHeading);
        
        // Create content container
        const contentContainer = document.createElement('div');
        contentContainer.style.padding = '10px';
        infoBox.appendChild(contentContainer);
        
        // Map domain keys to display names and element IDs
        const domainMapping = {
            "Data Gathering": { 
                id: 'dataGatheringCheckbox',
                title: 'Data Gathering'
            },
            "Management": { 
                id: 'managementCheckbox',
                title: 'Management'
            },
            "Interpersonal Skills": { 
                id: 'interpersonalSkillsCheckbox',
                title: 'Interpersonal Skills'
            }
        };
        
        // Populate points for each domain
        Object.entries(domainGroups).forEach(([domain, points]) => {
            if (!domainMapping[domain]) return;
            
            // Add domain title
            const titleEl = document.createElement('h3');
            titleEl.textContent = domainMapping[domain].title;
            titleEl.style.marginTop = domain === "Data Gathering" ? '0' : '20px';
            titleEl.style.marginBottom = '10px';
            titleEl.style.color = '#000';
            titleEl.style.fontWeight = 'bold';
            contentContainer.appendChild(titleEl);
            
            // Create points list
            const pointsList = document.createElement('ul');
            pointsList.style.listStyleType = 'disc';
            pointsList.style.marginLeft = '20px';
            pointsList.style.marginBottom = '15px';
            
            points.forEach(point => {
                const pointItem = document.createElement('li');
                pointItem.textContent = point;
                pointItem.style.marginBottom = '5px';
                pointsList.appendChild(pointItem);
            });
            
            contentContainer.appendChild(pointsList);
        });
    }

    // Add this function if it doesn't already exist
    function updateInTimeContent(sections) {
        const contentArray = Array.isArray(sections) ? sections.map(item => item.Point || '') : [];
        
        // Ensure we have 16 items, filling with empty strings if needed
        while (contentArray.length < 16) {
            contentArray.push('');
        }
        
        // Update content for each section
        for (let i = 1; i <= 16; i++) {
            const sectionContent = document.querySelector(`#section${i} .section-content`);
            sectionContent.innerHTML = contentArray[i-1] || '';
        }
    }

    // Add this function if it doesn't already exist
    function updateTimestampSelector(data) {
        const selector = document.getElementById('timestampSelector');
        if (!selector) return;
        
        selector.style.display = 'block';
        
        // Clear existing options
        selector.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select a timestamp';
        selector.appendChild(defaultOption);
        
        // Add timestamp options
        if (data && Array.isArray(data)) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value;
                option.textContent = item.label;
                selector.appendChild(option);
            });
        }
    }

    // Keep only this one updateInTimeSection function
    function updateInTimeSection(data) {
        if (data.type === 'updateActiveSection' && typeof data.section === 'number') {
            updateActiveSection(data.section);
        } else if (data.type === 'resetSections') {
            resetSections();
        }
    }

    // Helper functions for the inTime sections
    function updateActiveSection(activeSection) {
        for (var i = 1; i <= 16; i++) {
            var section = document.getElementById('section' + i);
            if (i === activeSection) {
                section.classList.add('active');
                scrollToSection(section);
            } else {
                section.classList.remove('active');
            }
        }
    }

    function scrollToSection(section) {
        const container = document.querySelector('.sections');
        if (container && section) {
            const sectionRect = section.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const scrollTo = container.scrollTop + sectionRect.top - containerRect.top - (containerRect.height / 2) + (sectionRect.height / 2);
            
            container.scrollTo({
                top: scrollTo,
                behavior: 'smooth'
            });
        }
    }

    function resetSections() {
        for (var i = 1; i <= 16; i++) {
            var section = document.getElementById('section' + i);
            if (section) {
                section.classList.remove('active');
            }
        }
    }

    // Add the missing updateChecklist function
    function updateChecklist(checklist) {
        if (Array.isArray(checklist)) {
            // Group checklist data by domain
            const domainGroups = {
                "Data Gathering": [],
                "Management": [],
                "Interpersonal Skills": []
            };
            
            // Populate the domain groups
            checklist.forEach(item => {
                const domain = item.Domain;
                if (domainGroups.hasOwnProperty(domain)) {
                    domainGroups[domain].push(item.Point);
                }
            });
            
            // Update the checkboxes
            updateCheckboxes(domainGroups);
        }
    }

    // Clipboard buttons and lightboxes functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to elements
        const candidateInfoBtn = document.getElementById('candidateInfoBtn');
        const findingsBtn = document.getElementById('findingsBtn');
        const candidateInfoLightbox = document.getElementById('candidateInfoLightbox');
        const findingsLightbox = document.getElementById('findingsLightbox');

        // Add event listeners for opening lightboxes
        if (candidateInfoBtn) {
            candidateInfoBtn.addEventListener('click', function() {
                candidateInfoLightbox.style.display = 'flex';
            });
        }

        if (findingsBtn) {
            findingsBtn.addEventListener('click', function() {
                findingsLightbox.style.display = 'flex';
            });
        }

        // Add event listeners for closing lightboxes
        document.querySelectorAll('.content-lightbox-close').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.content-lightbox').style.display = 'none';
            });
        });

        // Close lightboxes when clicking outside content
        document.querySelectorAll('.content-lightbox').forEach(lightbox => {
            lightbox.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    });

    // Add function to reset practice mode to welcome screen
    function resetPracticeToWelcomeScreen() {
        // Only perform reset if in practice mode
        if (state.mode !== 'practice') return;
        
        // 1. Reset and clear timer
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.click(); // Use the existing reset functionality
        }
        
        // 2. Clear any dynamically added elements from the simulator screen
        const simulatorLinkScreen = document.querySelector('.simulator-link-screen');
        if (simulatorLinkScreen) {
            // Remove any dynamically added top candidate info 
            const topCandidateInfo = simulatorLinkScreen.querySelector('.top-candidate-info');
            if (topCandidateInfo) {
                simulatorLinkScreen.removeChild(topCandidateInfo);
            }
            
            // Remove any findings box that was added
            const findingsBoxes = simulatorLinkScreen.querySelectorAll('.info-box');
            findingsBoxes.forEach(box => {
                const title = box.querySelector('.info-box-title');
                if (title && title.textContent.trim() === 'Findings') {
                    simulatorLinkScreen.removeChild(box);
                }
            });
            
            // Remove any dynamically added "Enter Room" button
            const enterRoomBtn = simulatorLinkScreen.querySelector('#enterRoomBtn');
            if (enterRoomBtn) {
                simulatorLinkScreen.removeChild(enterRoomBtn);
            }
            
            // Reset simulator-link-title visibility
            const simulatorLinkTitle = simulatorLinkScreen.querySelector('.simulator-link-title');
            if (simulatorLinkTitle) {
                simulatorLinkTitle.style.display = '';
            }
            
            // Make all simulator steps visible again and restore step numbers
            const simulatorSteps = simulatorLinkScreen.querySelectorAll('.simulator-step');
            simulatorSteps.forEach(step => {
                step.style.display = '';
                const stepNumber = step.querySelector('.simulator-step-number');
                if (stepNumber) {
                    stepNumber.style.display = '';
                }
            });
        }
        
        // 3. Clear any Jitsi session
        clearJitsiMeet();
        
        // 4. Hide the jitsi container
        const jitsiContainer = document.getElementById('jitsi-container');
        if (jitsiContainer) {
            jitsiContainer.style.display = 'none';
        }
        
        // 5. Re-enable the "Start Video Call" button
        const generateLinkButton2 = document.getElementById('generateLinkButton2');
        if (generateLinkButton2) {
            generateLinkButton2.style.display = 'block';
        }
        
        // 6. Hide clipboard buttons and reset lightboxes
        const floatingClipboardButtons = document.getElementById('floatingClipboardButtons');
        if (floatingClipboardButtons) {
            floatingClipboardButtons.style.display = 'none';
        }
        
        // Reset and hide lightboxes
        document.querySelectorAll('.content-lightbox').forEach(lightbox => {
            lightbox.style.display = 'none';
        });
        
        // 7. Return to welcome screen
        document.querySelector('.simulator-link-screen').classList.remove('active');
        document.querySelector('.practice-welcome-screen').classList.add('active');
        document.querySelector('.main-content').style.display = 'none';
        
        // Hide back button when returning to welcome screen
        const floatingBackBtn = document.getElementById('floatingBackBtn');
        if (floatingBackBtn) {
            floatingBackBtn.style.display = 'none';
        }
        
        // Close the BrainBank lightbox after case selection
        document.getElementById('lightbox').style.display = 'none';
        
        // Ensure mode parameter in URL is maintained as practice mode
        window.parent.postMessage({ type: 'modeChange', mode: 'practice' }, '*');
    }

    // Prevent text copying and replace with copyright message
    document.addEventListener('copy', function(e) {
        // Check if selection is within the simulator link box that needs to be copied
        const selection = window.getSelection();
        const simulatorLinkBox = document.getElementById('simulatorLinkBox');
        
        if (simulatorLinkBox && simulatorLinkBox.contains(selection.anchorNode)) {
            // Allow normal copy for the simulator link
            return;
        }
        
        // Otherwise prevent copying and show copyright message
        e.preventDefault();
        e.clipboardData.setData('text/plain', 'Made by TuringMedSchool - turingmedschool.com');
    });
    </script>
</body>
</html>