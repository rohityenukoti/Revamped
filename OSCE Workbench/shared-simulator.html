<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCE Shared Simulator</title>
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFDE59;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .main-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .simulator-box {
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
            padding: 20px;
        }
        
        .simulator-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #000;
            border-bottom: 3px solid #000;
            padding-bottom: 5px;
        }
        
        .video-container {
            position: relative;
            height: 400px;
            overflow: hidden;
            background-color: #f0f0f0;
            margin-bottom: 20px;
            border: 3px solid #000;
            display: none; /* Hide video container by default */
        }
        
        #jitsi-container {
            width: 100%;
            height: 100%;
        }
        
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #000;
            border-top: 5px solid #FFDE59;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .patient-info, .checklist-container {
            margin-bottom: 20px;
        }
        
        .patient-info-grid {
            display: grid;
            gap: 15px;
        }
        
        .patient-info-item {
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }
        
        .patient-info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .patient-info-item strong {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-size: 1.1em;
        }
        
        .checklist-domain {
            margin-bottom: 20px;
        }
        
        .checklist-domain h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #000;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .checklist-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 0px;
            background-color: #f9f9f9;
        }
        
        .checklist-item:hover {
            background-color: #f0f0f0;
        }
        
        .checklist-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .checklist-item-text {
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .checklist-options {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .checklist-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 0px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .checklist-option:hover {
            background-color: #e0e0e0;
        }
        
        .checklist-option input[type="radio"] {
            margin: 0;
            width: 16px;
            height: 16px;
            border: 2px solid #000;
            border-radius: 50%;
            position: relative;
        }
        
        .checklist-option.covered {
            color: #2d5016;
        }
        
        .checklist-option.covered input[type="radio"]:checked {
            background-color: #4CAF50;
            border-color: #2d5016;
        }
        
        .checklist-option.partial {
            color: #8B4513;
        }
        
        .checklist-option.partial input[type="radio"]:checked {
            background-color: #FF9800;
            border-color: #8B4513;
        }
        
        .checklist-option.missed {
            color: #8B0000;
        }
        
        .checklist-option.missed input[type="radio"]:checked {
            background-color: #F44336;
            border-color: #8B0000;
        }
        
        .checklist-option-label {
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .remarks-container {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        .remarks-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .remarks-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 2px solid #000;
            border-radius: 0px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .remarks-textarea:focus {
            outline: none;
            border-color: #FFDE59;
            box-shadow: 0 0 0 2px rgba(255, 222, 89, 0.3);
        }
        
        .submit-button {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 15px 25px;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            box-shadow: 5px 5px 0px #000;
            font-size: 1.1em;
            display: block;
            margin: 20px auto;
            max-width: 200px;
            text-align: center;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 0px #000;
        }
        
        .submit-button:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }
        
        .error-container, .success-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            color: white;
            border-radius: 0px;
            border: 3px solid #000;
            box-shadow: 5px 5px 0px #000;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .error-container {
            background-color: #ff6666;
        }
        
        .success-container {
            background-color: #66cc66;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .video-container {
                height: 300px;
            }
            
            .checklist-options {
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .checklist-option {
                padding: 6px 10px;
                font-size: 0.9em;
            }
            
            .checklist-option-label {
                font-size: 0.8em;
            }
        }
        
        .main-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #FFDE59;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .error-screen > div {
            background: white;
            padding: 30px;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
            max-width: 500px;
            width: 90%;
        }
        
        .action-button {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 10px 20px;
            border-radius: 0px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            margin-top: 20px;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }
        
        #start-video-btn {
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            padding: 15px 25px;
            border-radius: 0px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            box-shadow: 5px 5px 0px #000;
            font-size: 1.1em;
            display: block;
            margin: 0 auto 20px;
            max-width: 200px;
            text-align: center;
        }
        
        #start-video-btn:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 0px #000;
        }
        
        #start-video-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #000;
        }

        .score-summary {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
        }

        .score-summary-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #000;
            border-bottom: 3px solid #000;
            padding-bottom: 5px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .score-item:last-of-type {
            border-bottom: none;
            margin-bottom: 10px;
        }

        .score-label {
            font-weight: bold;
            color: #000;
        }

        .score-value {
            background-color: #f0f0f0;
            padding: 5px 15px;
            border-radius: 0px;
            border: 2px solid #000;
            font-weight: bold;
        }
        
        /* Add styles for report issue button */
        .floating-report-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background-color: #FFDE59;
            color: #000;
            border: 3px solid #000;
            border-radius: 0px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .floating-report-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }

        .floating-report-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        @media (max-width: 768px) {
            .floating-report-button {
                bottom: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Score Adjustment Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background: white;
            padding: 30px;
            border: 3px solid #000;
            border-radius: 0px;
            box-shadow: 7px 7px 0px #000;
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        
        .modal-title {
            font-weight: bold;
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #000;
            border-bottom: 3px solid #000;
            padding-bottom: 10px;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .score-adjustment-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 0px;
        }
        
        .score-adjustment-label {
            flex: 1;
            font-weight: bold;
        }
        
        .score-adjustment-controls {
            display: flex;
            align-items: center;
        }
        
        .score-adjustment-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #000;
            background: #FFDE59;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin: 0 8px;
        }
        
        .score-adjustment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 2px 2px 0px #000;
        }
        
        .score-adjustment-btn:active {
            transform: translate(1px, 1px);
            box-shadow: none;
        }
        
        .score-adjustment-value {
            width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        /* Remarks summary styles */
        .remarks-summary {
            margin-top: 20px;
            border-top: 2px solid #ddd;
            padding-top: 15px;
        }
        
        .remarks-summary-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #000;
        }
        
        .remarks-summary-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 0px;
        }
        
        .remarks-summary-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #000;
        }
        
        .remarks-summary-text {
            font-size: 0.9em;
            color: #333;
            white-space: pre-wrap;
            font-style: italic;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border: 3px solid #000;
            border-radius: 0px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0px #000;
        }
        
        .modal-btn.cancel {
            background: #fff;
            color: #000;
        }
        
        .modal-btn.submit {
            background: #FFDE59;
            color: #000;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px #000;
        }
        
        .modal-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }
        
        @media (max-width: 768px) {
            .modal-container {
                width: 85%;
                padding: 20px;
            }
            
            .score-adjustment-row {
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .score-adjustment-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Error and success messages -->
    <div id="errorContainer" class="error-container"></div>
    <div id="successContainer" class="success-container"></div>
    
    <!-- Floating Report Issue Button -->
    <button class="floating-report-button" id="reportIssueBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M14.778.085A.5.5 0 0 1 15 .5V8a.5.5 0 0 1-.314.464L14.5 8l.186.464-.003.001-.006.003-.023.009a12.435 12.435 0 0 1-.397.15c-.264.095-.631.223-1.047.35-.816.252-1.879.523-2.71.523-.847 0-1.548-.28-2.158-.525l-.028-.01C7.68 8.71 7.14 8.5 6.5 8.5c-.7 0-1.638.23-2.437.477A19.626 19.626 0 0 0 3 9.342V15.5a.5.5 0 0 1-1 0V.5a.5.5 0 0 1 1 0v.282c.226-.079.496-.17.79-.26C4.606.272 5.67 0 6.5 0c.84 0 1.524.277 2.121.519l.043.018C9.286.788 9.828 1 10.5 1c.7 0 1.638-.23 2.437-.477a19.587 19.587 0 0 0 1.349-.476l.019-.007.004-.002h.001"/>
        </svg>
        Report Issue
    </button>
    
    <div class="container">
        <div class="main-content">
            <div class="main-column">
                <!-- Video container -->
                <div class="simulator-box">
                    <div class="simulator-title">Video Call</div>
                    <button id="start-video-btn">Start Video Call</button>
                    <div class="video-container">
                        <div id="jitsi-container"></div>
                        <div class="loading-screen" id="loadingScreen">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Information -->
                <div class="simulator-box">
                    <div class="simulator-title">Patient Information</div>
                    <div class="patient-info">
                        <div class="patient-info-grid" id="patientInfoGrid">
                            <!-- Patient information will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-column">
                <!-- Examiner Checklist -->
                <div class="simulator-box">
                    <div class="simulator-title">Examiner Checklist</div>
                    <div class="checklist-container">
                        <!-- Data Gathering Section -->
                        <div class="checklist-domain">
                            <h3>Data Gathering</h3>
                            <div id="dataGatheringChecklist">
                                <!-- Checklist items will be loaded dynamically -->
                            </div>
                            <div class="remarks-container">
                                <label class="remarks-label" for="dataGatheringRemarks">Additional Remarks:</label>
                                <textarea id="dataGatheringRemarks" class="remarks-textarea" placeholder="Enter any additional remarks for data gathering..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Management Section -->
                        <div class="checklist-domain">
                            <h3>Management</h3>
                            <div id="managementChecklist">
                                <!-- Checklist items will be loaded dynamically -->
                            </div>
                            <div class="remarks-container">
                                <label class="remarks-label" for="managementRemarks">Additional Remarks:</label>
                                <textarea id="managementRemarks" class="remarks-textarea" placeholder="Enter any additional remarks for management..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Interpersonal Skills Section -->
                        <div class="checklist-domain">
                            <h3>Interpersonal Skills</h3>
                            <div id="interpersonalSkillsChecklist">
                                <!-- Checklist items will be loaded dynamically -->
                            </div>
                            <div class="remarks-container">
                                <label class="remarks-label" for="interpersonalSkillsRemarks">Additional Remarks:</label>
                                <textarea id="interpersonalSkillsRemarks" class="remarks-textarea" placeholder="Enter any additional remarks for interpersonal skills..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Score Summary Box -->
                <div class="simulator-box">
                    <div class="simulator-title">Score Summary</div>
                    <div class="score-summary">
                        <div class="score-item">
                            <span class="score-label">Data Gathering</span>
                            <span class="score-value" id="dataGatheringScore">0.00</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Management</span>
                            <span class="score-value" id="managementScore">0.00</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Interpersonal Skills</span>
                            <span class="score-value" id="interpersonalSkillsScore">0.00</span>
                        </div>
                        <button id="submitBtn" class="submit-button">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading states -->
    <div class="loading-screen main-loading" id="mainLoadingScreen">
        <div class="spinner"></div>
        <div style="margin-top: 20px; text-align: center;">
            <h3 style="margin-bottom: 10px;">Loading case data...</h3>
            <p>Please wait while we prepare your simulator.</p>
        </div>
    </div>
    
    <!-- Error state -->
    <div class="error-screen" id="errorScreen" style="display: none;">
        <div style="text-align: center;">
            <h3 style="margin-bottom: 15px;">Error Loading Case</h3>
            <p id="errorScreenMessage">We couldn't find the requested case. Please check the URL and try again.</p>
            <button class="action-button" onclick="window.location.href='https://turingmedschool.com'">Return to Homepage</button>
        </div>
    </div>
    
    <!-- Score Adjustment Modal -->
    <div class="modal-overlay" id="scoreAdjustmentModal">
        <div class="modal-container">
            <div class="modal-title">Adjust Scores</div>
            <div class="modal-body">
                <p>You can manually adjust the scores before final submission if needed.</p>
                
                <div class="score-adjustment-row">
                    <div class="score-adjustment-label">Data Gathering</div>
                    <div class="score-adjustment-controls">
                        <button class="score-adjustment-btn minus" data-domain="dataGathering">-</button>
                        <div class="score-adjustment-value" id="adjustDataGatheringScore">0</div>
                        <button class="score-adjustment-btn plus" data-domain="dataGathering">+</button>
                    </div>
                </div>
                
                <div class="score-adjustment-row">
                    <div class="score-adjustment-label">Management</div>
                    <div class="score-adjustment-controls">
                        <button class="score-adjustment-btn minus" data-domain="management">-</button>
                        <div class="score-adjustment-value" id="adjustManagementScore">0</div>
                        <button class="score-adjustment-btn plus" data-domain="management">+</button>
                    </div>
                </div>
                
                <div class="score-adjustment-row">
                    <div class="score-adjustment-label">Interpersonal Skills</div>
                    <div class="score-adjustment-controls">
                        <button class="score-adjustment-btn minus" data-domain="interpersonalSkills">-</button>
                        <div class="score-adjustment-value" id="adjustInterpersonalSkillsScore">0</div>
                        <button class="score-adjustment-btn plus" data-domain="interpersonalSkills">+</button>
                    </div>
                </div>
                
                <div class="remarks-summary">
                    <div class="remarks-summary-title">Remarks Summary</div>
                    
                    <div class="remarks-summary-item">
                        <div class="remarks-summary-label">Data Gathering Remarks</div>
                        <div class="remarks-summary-text" id="adjustDataGatheringRemarks">No remarks</div>
                    </div>
                    
                    <div class="remarks-summary-item">
                        <div class="remarks-summary-label">Management Remarks</div>
                        <div class="remarks-summary-text" id="adjustManagementRemarks">No remarks</div>
                    </div>
                    
                    <div class="remarks-summary-item">
                        <div class="remarks-summary-label">Interpersonal Skills Remarks</div>
                        <div class="remarks-summary-text" id="adjustInterpersonalSkillsRemarks">No remarks</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="cancelAdjustment">Cancel</button>
                <button class="modal-btn submit" id="confirmAdjustment">Submit Scores</button>
            </div>
        </div>
    </div>
    
    <script>
        // State variables
        let state = {
            caseIndex: null,
            userEmail: null,
            roomName: null,
            checklist: {
                dataGathering: {
                    points: [],
                    booleanArray: [],
                    remarks: ""
                },
                management: {
                    points: [],
                    booleanArray: [],
                    remarks: ""
                },
                interpersonalSkills: {
                    points: [],
                    booleanArray: [],
                    remarks: ""
                }
            },
            scores: {
                dataGathering: "0",
                management: "0",
                interpersonalSkills: "0"
            },
            jitsiApi: null,
            submitting: false,
            loading: true,
            hasInitializedJitsi: false,
            videoContainerShown: false
        };
        
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const submitBtn = document.getElementById('submitBtn');
        const patientInfoGrid = document.getElementById('patientInfoGrid');
        const dataGatheringChecklist = document.getElementById('dataGatheringChecklist');
        const managementChecklist = document.getElementById('managementChecklist');
        const interpersonalSkillsChecklist = document.getElementById('interpersonalSkillsChecklist');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // console.log("DOM loaded in HTML component");
            // console.log("Running in iframe:", window.self !== window.top);
            
            try {
                // console.log("Parent URL:", window.parent.location.href);
            } catch (e) {
                // console.log("Cannot access parent URL due to cross-origin restrictions");
            }
            
            // Don't try to read URL parameters immediately
            // Instead, wait for data from parent and show loading screen
            document.getElementById('mainLoadingScreen').style.display = 'flex';
            
            // Set up event listeners for the parent page
            setupEventListeners();
            
            // Signal to parent that we're ready to receive data
            // console.log("Posting simulatorReady message to parent");
            try {
                // Use '*' to allow cross-origin communication
                window.parent.postMessage({ type: 'simulatorReady' }, '*');
                // console.log("simulatorReady message posted successfully");
            } catch (error) {
                console.error("Error posting message to parent:", error);
            }
        });
        
        // Function to update patient information UI
        function updatePatientInfo(info) {
            // console.log("Updating patient info UI with:", info);
            patientInfoGrid.innerHTML = '';
            
            // Add the full patient information as rich text if it exists
            if (info.fullInfo) {
                const fullInfoItem = document.createElement('div');
                fullInfoItem.className = 'patient-info-item';
                
                // Use innerHTML to preserve HTML formatting
                fullInfoItem.innerHTML = info.fullInfo;
                
                patientInfoGrid.appendChild(fullInfoItem);
            } else {
                // Display a message if no patient info is available
                const noInfoItem = document.createElement('div');
                noInfoItem.className = 'patient-info-item';
                noInfoItem.textContent = 'No patient information available.';
                patientInfoGrid.appendChild(noInfoItem);
            }
            // console.log("Patient info UI updated");
        }
        
        // Function to update checklist UI
        function updateChecklistUI(data) {
            // console.log("Updating checklist UI with data:", data);
            // Clear previous checklist items
            dataGatheringChecklist.innerHTML = '';
            managementChecklist.innerHTML = '';
            interpersonalSkillsChecklist.innerHTML = '';
            
            // Reset state
            state.checklist = {
                dataGathering: {
                    points: data.dataGathering || [],
                    scoreArray: new Array((data.dataGathering || []).length).fill(0), // 0=missed, 0.5=partial, 1=covered
                    remarks: data.dataGatheringRemarks || ""
                },
                management: {
                    points: data.management || [],
                    scoreArray: new Array((data.management || []).length).fill(0), // 0=missed, 0.5=partial, 1=covered
                    remarks: data.managementRemarks || ""
                },
                interpersonalSkills: {
                    points: data.interpersonalSkills || [],
                    scoreArray: new Array((data.interpersonalSkills || []).length).fill(0), // 0=missed, 0.5=partial, 1=covered
                    remarks: data.interpersonalSkillsRemarks || ""
                }
            };
            
            // Generate checklist items for each domain
            createChecklistItems(dataGatheringChecklist, state.checklist.dataGathering.points, 'dataGathering');
            createChecklistItems(managementChecklist, state.checklist.management.points, 'management');
            createChecklistItems(interpersonalSkillsChecklist, state.checklist.interpersonalSkills.points, 'interpersonalSkills');
            
            // Initialize remarks textareas with any existing values
            document.getElementById('dataGatheringRemarks').value = state.checklist.dataGathering.remarks;
            document.getElementById('managementRemarks').value = state.checklist.management.remarks;
            document.getElementById('interpersonalSkillsRemarks').value = state.checklist.interpersonalSkills.remarks;
            
            // console.log("Checklist UI updated with", 
            //            state.checklist.dataGathering.points.length, 
            //            state.checklist.management.points.length, 
            //            state.checklist.interpersonalSkills.points.length, 
            //            "items");
        }
        
        // Function to create checklist items
        function createChecklistItems(container, items, domain) {
            items.forEach((item, index) => {
                const checklistItem = document.createElement('div');
                checklistItem.className = 'checklist-item';
                
                const itemContent = document.createElement('div');
                itemContent.className = 'checklist-item-content';
                
                const itemText = document.createElement('div');
                itemText.className = 'checklist-item-text';
                itemText.textContent = item;
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'checklist-options';
                
                // Create radio button options
                const options = [
                    { value: 1, label: 'Covered', class: 'covered' },
                    { value: 0.5, label: 'Partial', class: 'partial' },
                    { value: 0, label: 'Missed', class: 'missed' }
                ];
                
                options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `checklist-option ${option.class}`;
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `${domain}-${index}`;
                    radio.value = option.value;
                    radio.id = `${domain}-${index}-${option.value}`;
                    
                    // Set default to "Missed" (value 0)
                    if (option.value === 0) {
                        radio.checked = true;
                    }
                    
                    radio.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const newValue = parseFloat(e.target.value);
                            //console.log(`Radio changed in ${domain} at index ${index}. New value:`, newValue);
                            // Update state when radio is changed
                            state.checklist[domain].scoreArray[index] = newValue;
                            //console.log(`Updated score array for ${domain}:`, state.checklist[domain].scoreArray);
                            
                            // Calculate and update scores immediately
                            updateScores();
                        }
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = `${domain}-${index}-${option.value}`;
                    label.className = 'checklist-option-label';
                    label.textContent = option.label;
                    
                    // Add click event listener to the entire option div to make it fully clickable
                    optionDiv.addEventListener('click', (e) => {
                        // Prevent double-triggering if the radio button itself was clicked
                        if (e.target !== radio) {
                            radio.checked = true;
                            // Manually trigger the change event since programmatic changes don't fire it
                            radio.dispatchEvent(new Event('change'));
                        }
                    });
                    
                    optionDiv.appendChild(radio);
                    optionDiv.appendChild(label);
                    optionsContainer.appendChild(optionDiv);
                });
                
                itemContent.appendChild(itemText);
                itemContent.appendChild(optionsContainer);
                checklistItem.appendChild(itemContent);
                container.appendChild(checklistItem);
            });
        }
        
        // Function to update scores in the UI
        function updateScores() {
            //console.log("Updating scores...");
            const dataGatheringScore = calculateScore(state.checklist.dataGathering.scoreArray);
            const managementScore = calculateScore(state.checklist.management.scoreArray);
            const interpersonalSkillsScore = calculateScore(state.checklist.interpersonalSkills.scoreArray);
            
            //console.log("Calculated scores: " + 
            //    JSON.stringify({
            //        dataGathering: dataGatheringScore,
            //        management: managementScore,
            //        interpersonalSkills: interpersonalSkillsScore
            //    })
            //);

            // Store scores in state
            state.scores.dataGathering = dataGatheringScore;
            state.scores.management = managementScore;
            state.scores.interpersonalSkills = interpersonalSkillsScore;

            // Update score display
            document.getElementById('dataGatheringScore').textContent = dataGatheringScore;
            document.getElementById('managementScore').textContent = managementScore;
            document.getElementById('interpersonalSkillsScore').textContent = interpersonalSkillsScore;
        }
        
        // Function to calculate the score for a domain (scaled to max of 4)
        function calculateScore(scoreArray) {
            if (!scoreArray || scoreArray.length === 0) {
                //console.log("Invalid score array for score calculation:", scoreArray);
                return "0.00";
            }
            
            // Calculate total points - now the values are already the points
            // 0 = missed (0 points), 0.5 = partial (0.5 points), 1 = covered (1 point)
            let totalPoints = 0;
            scoreArray.forEach(score => {
                totalPoints += score; // Direct addition since values are already the points
            });
            
            //console.log("Total points:", totalPoints, "out of", scoreArray.length, "items");
            
            // Calculate raw score as percentage of total possible points
            const maxPossiblePoints = scoreArray.length; // Each item can get max 1 point
            const rawScore = totalPoints / maxPossiblePoints;
            
            // Scale to max of 4
            const scaledScore = rawScore * 4;
            //console.log("Raw score:", rawScore, "Scaled score:", scaledScore);
            
            // Return the score as a string with 2 decimal places
            return scaledScore.toFixed(2);
        }
        
        // Function to initialize Jitsi
        function initializeJitsiMeet() {
            // Prevent multiple initializations
            if (state.hasInitializedJitsi || !state.roomName) {
                // console.log("Jitsi already initialized or no room name, skipping initialization");
                return;
            }
            
            // console.log("Initializing Jitsi meet with room:", state.roomName);
            try {
                const domain = 'jitsi.dorf-post.de';
                const options = {
                    roomName: state.roomName,
                    width: '100%',
                    height: '100%',
                    parentNode: document.getElementById('jitsi-container'),
                    configOverwrite: {
                        logging: {
                            defaultLogLevel: 'error',
                            loggers: {
                                'modules/RTC/TraceablePeerConnection.js': 'error',
                                'modules/xmpp/strophe.util.js': 'error',
                            },
                        },
                        prejoinConfig: {
                            enabled: false
                        },
                        deeplinking: {
                            disabled: true
                        }
                    },
                    interfaceConfigOverwrite: {
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop', 
                            'fullscreen', 'fodeviceselection', 'hangup', 'profile', 
                            'chat', 'recording', 'livestreaming', 'etherpad', 
                            'sharedvideo', 'settings', 'raisehand', 'videoquality', 
                            'filmstrip', 'feedback', 'stats', 'shortcuts',
                            'tileview', 'videobackgroundblur', 'download', 'help',
                            'mute-everyone', 'security'
                        ]
                    }
                };
                
                // console.log("Creating Jitsi API with options:", JSON.stringify(options));
                state.jitsiApi = new JitsiMeetExternalAPI(domain, options);
                // Mark as initialized
                state.hasInitializedJitsi = true;
                // console.log("Jitsi API created successfully");
                
                // Set display name (email)
                state.jitsiApi.executeCommand('displayName', state.userEmail);
                
                // Hide loading screen once the meeting is joined
                state.jitsiApi.addEventListener('videoConferenceJoined', () => {
                    // console.log("Video conference joined");
                    loadingScreen.style.display = 'none';
                });
                
                // Handle video conference left
                state.jitsiApi.addEventListener('videoConferenceLeft', handleVideoConferenceLeft);
            } catch (error) {
                console.error('Error initializing Jitsi:', error);
                showError('Could not initialize video call. Please refresh the page and try again.', true);
                loadingScreen.style.display = 'none';
            }
        }
        
        // Function to set up event listeners
        function setupEventListeners() {
            // Submit button click event
            submitBtn.addEventListener('click', handleSubmit);
            
            // Start video button click event
            document.getElementById('start-video-btn').addEventListener('click', handleStartVideo);
            
            // Listen for messages from the parent page
            window.addEventListener('message', handleParentMessage);
            
            // Report Issue button click event
            const reportIssueBtn = document.getElementById('reportIssueBtn');
            if (reportIssueBtn) {
                reportIssueBtn.addEventListener('click', function() {
                    // Show loading screen
                    document.getElementById('mainLoadingScreen').style.display = 'flex';
                    
                    // Navigate to the feedback page within the application
                    window.parent.postMessage({ 
                        type: 'navigate', 
                        data: { url: '/user-feedback' } 
                    }, '*');
                });
            }
            
            // Score adjustment modal events
            document.getElementById('cancelAdjustment').addEventListener('click', function() {
                hideScoreAdjustmentModal();
            });
            
            document.getElementById('confirmAdjustment').addEventListener('click', function() {
                submitAdjustedScores();
            });
            
            // Score adjustment buttons
            const plusButtons = document.querySelectorAll('.score-adjustment-btn.plus');
            plusButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const domain = this.getAttribute('data-domain');
                    handleScoreAdjustment(domain, 1);
                });
            });
            
            const minusButtons = document.querySelectorAll('.score-adjustment-btn.minus');
            minusButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const domain = this.getAttribute('data-domain');
                    handleScoreAdjustment(domain, -1);
                });
            });
        }
        
        // Handle messages from parent page
        function handleParentMessage(event) {
            // console.log("Message received from parent:", event.data?.type, event.data);
            // console.log("Message origin:", event.origin);
            
            // Don't check event origin to allow cross-origin communication
            if (!event.data || !event.data.type) return;
            
            switch (event.data.type) {
                case 'caseData':
                    // console.log("Case data received from parent, processing now...");
                    handleCaseData(event.data.data);
                    break;
                    
                case 'showError':
                    showError(event.data.message, event.data.isCritical);
                    break;
                    
                case 'submissionSuccess':
                    handleSubmissionSuccess();
                    break;
            }
        }
        
        // Handle case data from parent
        function handleCaseData(data) {
            // console.log("Processing case data in handleCaseData:", data);
            state.loading = false;
            
            // Clear the loading timeout since we've received data
            if (loadTimeoutId) {
                // console.log("Clearing load timeout - data received");
                clearTimeout(loadTimeoutId);
                loadTimeoutId = null;
            }
            
            if (!data) {
                console.error("No case data received in HTML component");
                showError("No case data received.", true);
                return;
            }
            
            try {
                // console.log("Patient info received:", data.patientInfo);
                // console.log("Checklist received:", data.checklist);
                
                // Update UI with received data
                updatePatientInfo(data.patientInfo);
                updateChecklistUI(data.checklist);
                
                // Update state variables from parent data
                state.roomName = data.roomName;
                state.userEmail = data.userEmail;
                state.caseIndex = data.caseIndex;
                
                // console.log("Updated state in HTML component:", {
                //     roomName: state.roomName,
                //     userEmail: state.userEmail,
                //     caseIndex: state.caseIndex
                // });
                
                // Don't initialize Jitsi automatically - wait for button click
                // Just check if room name exists to enable/disable the button
                if (!state.roomName) {
                    // console.log("No room name provided, hiding video button");
                    document.getElementById('start-video-btn').style.display = 'none';
                }
                
                // Hide main loading screen
                document.getElementById('mainLoadingScreen').style.display = 'none';
                
                // Hide error screen if it was shown
                document.getElementById('errorScreen').style.display = 'none';
            } catch (error) {
                console.error("Error processing case data:", error);
                showError("Error processing case data: " + error.message, true);
            }
        }
        
        // Function to handle form submission
        function handleSubmit() {
            // Prevent multiple submissions
            if (state.submitting) {
                // console.log("Submit already in progress, ignoring click");
                return;
            }
            
            // Validate that at least some items are not "Missed" (value 0)
            const totalNonMissed = state.checklist.dataGathering.scoreArray.filter(score => score > 0).length +
                                 state.checklist.management.scoreArray.filter(score => score > 0).length +
                                 state.checklist.interpersonalSkills.scoreArray.filter(score => score > 0).length;
            
            // console.log("Total items not missed:", totalNonMissed);
            
            if (totalNonMissed === 0) {
                showError("Please mark at least one item as Covered or Partial before submitting.");
                return;
            }
            
            // Calculate scores for each domain
            const dataGatheringScore = calculateScore(state.checklist.dataGathering.scoreArray);
            const managementScore = calculateScore(state.checklist.management.scoreArray);
            const interpersonalSkillsScore = calculateScore(state.checklist.interpersonalSkills.scoreArray);
            
            // Update score display
            document.getElementById('dataGatheringScore').textContent = dataGatheringScore;
            document.getElementById('managementScore').textContent = managementScore;
            document.getElementById('interpersonalSkillsScore').textContent = interpersonalSkillsScore;
            
            // Store scores in state
            state.scores.dataGathering = dataGatheringScore;
            state.scores.management = managementScore;
            state.scores.interpersonalSkills = interpersonalSkillsScore;
            
            // Show the score adjustment modal with current scores
            showScoreAdjustmentModal();
        }
        
        // Helper function to reset the submit button
        function resetSubmitButton() {
            state.submitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
            submitBtn.style.backgroundColor = "#FFDE59";
            submitBtn.style.cursor = "pointer";
        }
        
        // Handle successful submission
        function handleSubmissionSuccess() {
            // console.log("Submission successful");
            loadingScreen.style.display = 'none';
            showMessage("Your checklist has been successfully submitted!", "success");
            
            // Update UI to show submission is complete
            submitBtn.disabled = true;
            submitBtn.textContent = "Submitted ✓";
            submitBtn.style.backgroundColor = "#66cc66";
            submitBtn.style.cursor = "not-allowed";
            
            state.submitting = false;
        }
        
        // Helper function to show error messages
        function showError(message, isCritical = false) {
            // console.log(`Error: ${message} (Critical: ${isCritical})`);
            if (isCritical) {
                showErrorScreen(message);
            } else {
                showMessage(message, "error");
            }
        }
        
        // Helper function to show messages
        function showMessage(message, type) {
            const container = type === "error" ? 
                document.getElementById('errorContainer') : 
                document.getElementById('successContainer');
            
            container.textContent = message;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }
        
        // Helper function to capitalize first letter of a string
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Show error screen with custom message
        function showErrorScreen(message) {
            // console.log(`Showing error screen with message: ${message}`);
            document.getElementById('errorScreenMessage').textContent = message || "We couldn't find the requested case. Please check the URL and try again.";
            document.getElementById('errorScreen').style.display = 'flex';
            document.getElementById('mainLoadingScreen').style.display = 'none';
        }
        
        // Add timeout to show error screen if data doesn't load
        let loadTimeoutId = setTimeout(() => {
            // console.log("Load timeout fired. Current loading state:", state.loading);
            if (state.loading) {
                showErrorScreen("It's taking longer than expected to load the case data. Please check your internet connection or try again later.");
            }
        }, 15000); // 15 seconds timeout

        // Clean up timeout if page unloads
        window.addEventListener('beforeunload', () => {
            clearTimeout(loadTimeoutId);
        });
        
        // Function to handle Start Video button click
        function handleStartVideo() {
            if (state.videoContainerShown) return;
            
            // Hide the button
            document.getElementById('start-video-btn').style.display = 'none';
            
            // Show video container
            document.querySelector('.video-container').style.display = 'block';
            state.videoContainerShown = true;
            
            // Show loading screen inside video container
            loadingScreen.style.display = 'flex';
            
            // Initialize Jitsi
            if (state.roomName) {
                initializeJitsiMeet();
            } else {
                loadingScreen.style.display = 'none';
                showError("No video room is available for this session.", true);
            }
        }

        // Handle video conference left
        function handleVideoConferenceLeft() {
            // Clear the Jitsi instance
            if (state.jitsiApi) {
                // Properly dispose of the Jitsi API instance
                state.jitsiApi.dispose();
                state.jitsiApi = null;
                state.hasInitializedJitsi = false;
            }
            
            // Make sure loading screen is hidden
            loadingScreen.style.display = 'none';
            
            // Hide the video container and show the button again
            document.querySelector('.video-container').style.display = 'none';
            document.getElementById('start-video-btn').style.display = 'block';
            state.videoContainerShown = false;
        }

        // Function to show the score adjustment modal
        function showScoreAdjustmentModal() {
            // Get remarks from textareas
            state.checklist.dataGathering.remarks = document.getElementById('dataGatheringRemarks').value.trim();
            state.checklist.management.remarks = document.getElementById('managementRemarks').value.trim();
            state.checklist.interpersonalSkills.remarks = document.getElementById('interpersonalSkillsRemarks').value.trim();
            
            // Update the modal with current scores
            document.getElementById('adjustDataGatheringScore').textContent = state.scores.dataGathering;
            document.getElementById('adjustManagementScore').textContent = state.scores.management;
            document.getElementById('adjustInterpersonalSkillsScore').textContent = state.scores.interpersonalSkills;
            
            // Update remarks in the modal
            document.getElementById('adjustDataGatheringRemarks').textContent = 
                state.checklist.dataGathering.remarks || "No remarks";
            document.getElementById('adjustManagementRemarks').textContent = 
                state.checklist.management.remarks || "No remarks";
            document.getElementById('adjustInterpersonalSkillsRemarks').textContent = 
                state.checklist.interpersonalSkills.remarks || "No remarks";
            
            // Show the modal
            const modal = document.getElementById('scoreAdjustmentModal');
            modal.classList.add('active');
        }
        
        // Function to hide the score adjustment modal
        function hideScoreAdjustmentModal() {
            // Update the main score summary with the current state scores
            document.getElementById('dataGatheringScore').textContent = state.scores.dataGathering;
            document.getElementById('managementScore').textContent = state.scores.management;
            document.getElementById('interpersonalSkillsScore').textContent = state.scores.interpersonalSkills;
            
            const modal = document.getElementById('scoreAdjustmentModal');
            modal.classList.remove('active');
        }
        
        // Function to handle score adjustment button clicks
        function handleScoreAdjustment(domain, increment) {
            // Get current score as a number
            let currentScore = parseInt(state.scores[domain], 10);
            
            // Adjust score, keeping it between 0 and 4
            let newScore = Math.max(0, Math.min(4, currentScore + increment));
            
            // Update state
            state.scores[domain] = newScore.toString();
            
            // Update modal display
            document.getElementById(`adjust${capitalizeFirstLetter(domain)}Score`).textContent = newScore;
            
            // Also update the main score summary display
            document.getElementById(`${domain}Score`).textContent = newScore.toString();
        }
        
        // Function to submit final adjusted scores
        function submitAdjustedScores() {
            // Set submitting state
            state.submitting = true;
            
            // Update UI to show submission in progress
            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting...";
            submitBtn.style.backgroundColor = "#cccccc";
            submitBtn.style.cursor = "not-allowed";
            
            // Make sure the score summary is updated to reflect adjusted scores
            document.getElementById('dataGatheringScore').textContent = state.scores.dataGathering;
            document.getElementById('managementScore').textContent = state.scores.management;
            document.getElementById('interpersonalSkillsScore').textContent = state.scores.interpersonalSkills;
            
            // Get remarks from textareas
            state.checklist.dataGathering.remarks = document.getElementById('dataGatheringRemarks').value.trim();
            state.checklist.management.remarks = document.getElementById('managementRemarks').value.trim();
            state.checklist.interpersonalSkills.remarks = document.getElementById('interpersonalSkillsRemarks').value.trim();
            
            // Show loading screen
            loadingScreen.style.display = 'flex';
            
            // Hide the modal
            hideScoreAdjustmentModal();
            
            // Prepare the data to be submitted with adjusted scores
            const submissionData = {
                userID: state.userEmail,
                caseIndex: state.caseIndex,
                timestamp: new Date().toISOString(),
                responses: {
                    dataGathering: {
                        scoreArray: state.checklist.dataGathering.scoreArray,
                        score: state.scores.dataGathering,
                        remarks: state.checklist.dataGathering.remarks
                    },
                    management: {
                        scoreArray: state.checklist.management.scoreArray,
                        score: state.scores.management,
                        remarks: state.checklist.management.remarks
                    },
                    interpersonalSkills: {
                        scoreArray: state.checklist.interpersonalSkills.scoreArray,
                        score: state.scores.interpersonalSkills,
                        remarks: state.checklist.interpersonalSkills.remarks
                    }
                }
            };
            
            try {
                // Send the data to the parent page for submission
                window.parent.postMessage({
                    type: 'submitChecklist',
                    data: submissionData
                }, '*');
                
                // Set a timeout in case we don't get a response from the parent
                setTimeout(function() {
                    if (state.submitting) {
                        loadingScreen.style.display = 'none';
                        showError("Submission timed out. Please try again.");
                        resetSubmitButton();
                    }
                }, 10000); // 10 seconds timeout
            } catch (error) {
                console.error("Error sending submission:", error);
                loadingScreen.style.display = 'none';
                showError("Error submitting checklist: " + error.message);
                resetSubmitButton();
            }
        }
        
        // Prevent text copying and replace with copyright message
        document.addEventListener('copy', function(e) {
            e.preventDefault();
            e.clipboardData.setData('text/plain', 'Made by TuringMedSchool - turingmedschool.com');
        });
    </script>
</body>
</html> 